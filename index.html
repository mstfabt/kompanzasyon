<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kompanzasyon Tasarƒ±m ve Hesaplama Sistemi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            /* Profesyonel Elektrik/Enerji Temasƒ± */
            --primary-color: #0ea5e9; /* Sky Blue - Elektrik */
            --primary-dark: #0284c7;
            --primary-light: #7dd3fc;
            --secondary-color: #8b5cf6; /* Purple - G√º√ß */
            --accent-color: #f59e0b; /* Amber - Enerji */
            --success-color: #10b981; /* Emerald */
            --warning-color: #f59e0b; /* Amber */
            --danger-color: #ef4444; /* Red */
            --info-color: #06b6d4; /* Cyan */

            /* Backgrounds */
            --dark-bg: #0f172a;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;

            /* Text Colors */
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 20px rgba(14, 165, 233, 0.3);

            /* Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            padding: 1rem;
            min-height: 100vh;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -20%;
            right: -20%;
            width: 140%;
            height: 140%;
            background: radial-gradient(circle at 70% 30%, rgba(14, 165, 233, 0.08) 0%, transparent 50%);
            pointer-events: none;
            will-change: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, #0f172a 0%, #0284c7 50%, #0ea5e9 100%);
            color: white;
            padding: clamp(2rem, 5vw, 3rem) 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
            pointer-events: none;
        }

        h1 {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 800;
            margin-bottom: 0.75rem;
            position: relative;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: clamp(0.95rem, 2vw, 1.1rem);
            opacity: 0.95;
            font-weight: 400;
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }

        .content {
            padding: clamp(1.5rem, 4vw, 2.5rem);
            max-width: 100%;
            overflow-x: hidden;
        }

        .section {
            margin-bottom: clamp(1.5rem, 4vw, 2.5rem);
            padding: clamp(1.25rem, 3vw, 2rem);
            background: white;
            border-radius: var(--radius-xl);
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--shadow-sm);
            transition: box-shadow var(--transition-base), border-left-color var(--transition-base);
            will-change: box-shadow;
        }

        .section:hover {
            box-shadow: var(--shadow-md);
            border-left-color: var(--secondary-color);
        }

        .section h2 {
            color: var(--text-primary);
            margin-bottom: clamp(1rem, 3vw, 1.5rem);
            font-size: clamp(1.35rem, 3.5vw, 1.8rem);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            letter-spacing: -0.01em;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 220px), 1fr));
            gap: clamp(0.75rem, 2vw, 1.25rem);
            margin-bottom: 1.25rem;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: clamp(0.85rem, 1.5vw, 0.95rem);
            word-wrap: break-word;
        }

        input, select {
            padding: 0.875rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: clamp(0.9rem, 1.5vw, 0.95rem);
            transition: all var(--transition-base);
            width: 100%;
            max-width: 100%;
            font-family: inherit;
            background: white;
        }

        input:hover, select:hover {
            border-color: var(--primary-light);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        button {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: clamp(0.875rem, 2vw, 1rem) clamp(1.75rem, 3vw, 2.25rem);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: clamp(0.9rem, 1.8vw, 1rem);
            font-weight: 600;
            transition: all var(--transition-base);
            white-space: nowrap;
            min-width: 0;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .equipment-list {
            margin-top: clamp(1rem, 3vw, 1.5rem);
        }

        .equipment-item {
            background: white;
            padding: clamp(0.875rem, 2vw, 1.125rem);
            margin-bottom: 0.875rem;
            border-radius: var(--radius-lg);
            border: 2px solid var(--border-color);
            border-left: 3px solid var(--primary-color);
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            min-width: 0;
            max-width: 100%;
            transition: box-shadow var(--transition-fast), border-color var(--transition-fast);
        }

        .equipment-item:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        .equipment-details {
            flex: 1;
            min-width: 0;
            word-wrap: break-word;
        }

        .equipment-details strong {
            color: var(--text-primary);
            font-size: clamp(1rem, 2vw, 1.1rem);
            display: block;
            margin-bottom: 0.25rem;
        }

        .remove-btn {
            background: var(--danger-color);
            padding: clamp(0.5rem, 1.5vw, 0.625rem) clamp(0.75rem, 2vw, 1rem);
            font-size: clamp(0.85rem, 1.5vw, 0.9rem);
            white-space: nowrap;
        }

        .results {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: clamp(1.5rem, 4vw, 2.5rem);
            border-radius: var(--radius-2xl);
            margin-top: clamp(2rem, 4vw, 3rem);
            max-width: 100%;
            overflow-x: hidden;
            border: 1px solid rgba(14, 165, 233, 0.2);
            box-shadow: var(--shadow-lg);
        }

        .results h2 {
            color: var(--text-primary);
            margin-bottom: clamp(1.5rem, 3vw, 2rem);
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 800;
            text-align: center;
            letter-spacing: -0.02em;
        }

        .result-card {
            background: white;
            padding: clamp(1.25rem, 3vw, 1.75rem);
            border-radius: var(--radius-xl);
            margin-bottom: 1.25rem;
            box-shadow: var(--shadow-sm);
            max-width: 100%;
            overflow-x: auto;
            min-width: 0;
            transition: box-shadow var(--transition-fast);
            border: 1px solid var(--border-light);
        }

        .result-card:hover {
            box-shadow: var(--shadow-md);
        }

        .result-card h3 {
            color: var(--primary-color);
            margin-bottom: clamp(0.875rem, 2vw, 1.125rem);
            font-size: clamp(1.15rem, 3vw, 1.4rem);
            font-weight: 700;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 0.75rem;
            letter-spacing: -0.01em;
            position: relative;
        }

        .result-card h3::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--secondary-color);
            border-radius: 2px;
        }

        .result-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: baseline;
            padding: clamp(0.5rem, 1.5vw, 0.75rem) 0;
            border-bottom: 1px solid var(--border-color);
            gap: 0.5rem;
            min-width: 0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: clamp(0.9rem, 1.8vw, 0.95rem);
            min-width: 0;
            word-wrap: break-word;
        }

        .result-value {
            color: var(--text-primary);
            font-weight: 700;
            font-size: clamp(1rem, 2vw, 1.1rem);
            text-align: right;
            min-width: 0;
            word-wrap: break-word;
        }

        .stage-card {
            background: var(--light-bg);
            padding: clamp(0.875rem, 2.5vw, 1.25rem);
            margin: clamp(0.625rem, 2vw, 0.875rem) 0;
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-color);
            max-width: 100%;
            overflow-x: auto;
        }

        .stage-card h4 {
            color: var(--text-primary);
            font-size: clamp(1rem, 2.5vw, 1.15rem);
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid var(--warning-color);
            padding: clamp(0.875rem, 2.5vw, 1.25rem);
            border-radius: var(--radius-md);
            margin: clamp(0.875rem, 2.5vw, 1.25rem) 0;
            color: #856404;
            font-size: clamp(0.9rem, 1.8vw, 0.95rem);
            max-width: 100%;
            word-wrap: break-word;
        }

        .info {
            background: #d1ecf1;
            border: 2px solid var(--info-color);
            padding: clamp(0.875rem, 2.5vw, 1.25rem);
            border-radius: var(--radius-md);
            margin: clamp(0.875rem, 2.5vw, 1.25rem) 0;
            color: #0c5460;
            font-size: clamp(0.9rem, 1.8vw, 0.95rem);
            max-width: 100%;
            word-wrap: break-word;
        }

        .group-section {
            background: white;
            padding: clamp(1rem, 3vw, 1.5rem);
            margin: clamp(0.875rem, 2.5vw, 1.25rem) 0;
            border-radius: var(--radius-md);
            border: 2px solid var(--primary-color);
            max-width: 100%;
            overflow-x: auto;
        }

        .group-section h3 {
            color: var(--primary-color);
            font-size: clamp(1.1rem, 2.5vw, 1.3rem);
            font-weight: 700;
            margin-bottom: clamp(0.75rem, 2vw, 1rem);
        }

        .connected-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .link-btn {
            background: linear-gradient(135deg, #ffa07a 0%, #ff6347 100%);
            padding: 6px 12px;
            font-size: 0.85em;
            margin-left: 5px;
        }

        .unlink-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 6px 12px;
            font-size: 0.85em;
            margin-left: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow: auto;
            padding: 1rem;
        }

        .modal-content {
            background-color: white;
            margin: clamp(1rem, 5vh, 3rem) auto;
            padding: clamp(1.25rem, 4vw, 2rem);
            border-radius: var(--radius-xl);
            width: min(90%, 600px);
            max-width: 100%;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            color: var(--text-primary);
            margin-bottom: clamp(1rem, 3vw, 1.5rem);
            font-size: clamp(1.25rem, 3vw, 1.5rem);
            font-weight: 700;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.75rem;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .connection-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connection-item:hover {
            border-color: #667eea;
            background: #e8ecff;
        }

        .connection-item.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .chart-container {
            position: relative;
            height: clamp(250px, 40vw, 350px);
            margin: clamp(1rem, 3vw, 1.5rem) 0;
            background: white;
            padding: clamp(1rem, 3vw, 1.5rem);
            border-radius: var(--radius-lg);
            max-width: 100%;
            overflow-x: auto;
        }

        .action-buttons {
            display: flex;
            gap: clamp(0.5rem, 2vw, 0.75rem);
            flex-wrap: wrap;
            justify-content: center;
            margin: clamp(1rem, 3vw, 1.5rem) 0;
            max-width: 100%;
        }

        .save-load-section {
            background: #fff9e6;
            border: 2px solid var(--warning-color);
            padding: clamp(1rem, 3vw, 1.25rem);
            border-radius: var(--radius-md);
            margin: clamp(0.875rem, 2.5vw, 1.25rem) 0;
            max-width: 100%;
        }

        .save-load-section h3 {
            color: #856404;
            font-size: clamp(1rem, 2.5vw, 1.15rem);
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            margin-right: 10px;
            transition: transform 0.2s;
        }

        .file-label:hover {
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: clamp(1.25rem, 3vw, 1.75rem);
            right: clamp(1.25rem, 3vw, 1.75rem);
            padding: clamp(1rem, 2.5vw, 1.25rem) clamp(1.5rem, 3vw, 1.875rem);
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 600;
            font-size: clamp(0.9rem, 1.8vw, 0.95rem);
            box-shadow: var(--shadow-xl);
            z-index: 2000;
            animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: none;
            max-width: min(90%, 420px);
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: rgba(255, 255, 255, 0.6);
            animation: progress 2.5s linear;
        }

        @keyframes progress {
            from { height: 100%; }
            to { height: 0; }
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #34d399 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger-color) 0%, #f87171 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--info-color) 0%, var(--primary-color) 100%);
        }

        @keyframes slideInBounce {
            0% {
                transform: translateX(500px) scale(0.8);
                opacity: 0;
            }
            60% {
                transform: translateX(-20px) scale(1.05);
                opacity: 1;
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
        }

        .loading-spinner.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(14, 165, 233, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
            text-align: center;
            animation: pulse-text 1.5s ease-in-out infinite;
        }

        @keyframes pulse-text {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2999;
        }

        .loading-overlay.active {
            display: block;
        }

        .print-button {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        #designMode {
            border: 3px solid #667eea;
            background: linear-gradient(135deg, #f8f9fa 0%, #e8ecff 100%);
        }

        #designMode:focus {
            border-color: #764ba2;
            outline: none;
        }

        .section:has(#designMode) {
            background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
            border-left-color: #2196f3;
            border-left-width: 8px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .section, .action-buttons, button, .save-load-section {
                display: none !important;
            }

            .container {
                box-shadow: none;
            }

            .results {
                page-break-inside: avoid;
            }

            header {
                background: #1e3c72 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: clamp(1rem, 3vw, 1.25rem);
            }

            .result-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .result-value {
                text-align: left;
                margin-top: 0.25rem;
            }

            .equipment-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .remove-btn, .link-btn, .unlink-btn {
                align-self: flex-end;
                margin-left: 0;
                margin-top: 0.5rem;
            }

            .modal-content {
                width: min(95%, 100%);
                margin: 1rem auto;
                padding: 1.25rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .notification {
                left: 1rem;
                right: 1rem;
                max-width: calc(100% - 2rem);
            }

            h1 {
                letter-spacing: -0.03em;
            }

            .result-card h3 {
                letter-spacing: -0.02em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Kompanzasyon Tasarƒ±m ve Hesaplama Sistemi</h1>
            <p class="subtitle">Harmonikler ve Reaktif G√º√ß Kompanzasyonu - Profesyonel Hesaplama Aracƒ±</p>
        </header>

        <div class="content">
            <!-- Sistem Parametreleri -->
            <div class="section">
                <h2>üîß Sistem Parametreleri</h2>

                <!-- Tasarƒ±m Modu Se√ßimi -->
                <div class="input-group" style="margin-bottom: 25px;">
                    <div class="input-field" style="grid-column: 1 / -1;">
                        <label style="font-size: 1.1em; color: #667eea; margin-bottom: 10px;">‚öôÔ∏è Tasarƒ±m Modu</label>
                        <select id="designMode" onchange="updateDesignMode()" style="font-size: 1em; padding: 12px; font-weight: 600;">
                            <option value="new">üÜï Sƒ±fƒ±rdan Yeni Sistem Tasarƒ±mƒ±</option>
                            <option value="upgrade">üîÑ Mevcut Sistemi Geli≈ütirme</option>
                            <option value="powerBased">‚ö° Sadece Aktif G√º√ß Bazlƒ± Hesaplama</option>
                        </select>
                        <small id="modeDescription" style="display: block; margin-top: 8px; color: #666; font-weight: normal;">
                            Mevcut Cos œÜ deƒüerini dikkate almadan, sadece motorlar ve cihazlar √ºzerinden tam sistem tasarƒ±mƒ± yapƒ±lƒ±r.
                        </small>
                    </div>
                </div>

                <div class="input-group">
                    <div class="input-field">
                        <label>Sistem Voltajƒ± (V)</label>
                        <input type="number" id="systemVoltage" value="400" placeholder="√ñrn: 400">
                    </div>
                    <div class="input-field">
                        <label>Sistem Frekansƒ± (Hz)</label>
                        <input type="number" id="systemFrequency" value="50" placeholder="√ñrn: 50">
                    </div>
                    <div class="input-field" id="currentPFField">
                        <label>Mevcut Cos œÜ <span style="color: #999;">(Opsiyonel - Yeni tasarƒ±mda kullanƒ±lmaz)</span></label>
                        <input type="number" id="currentPowerFactor" value="0.7" step="0.01" min="0" max="1" placeholder="√ñrn: 0.7" disabled>
                    </div>
                    <div class="input-field">
                        <label>Hedef Cos œÜ</label>
                        <input type="number" id="targetPowerFactor" value="0.95" step="0.01" min="0" max="1" placeholder="√ñrn: 0.95">
                    </div>
                </div>

                <!-- Enerji Maliyeti ve ROI Parametreleri -->
                <div class="input-group" style="background: #e8f5e9; padding: clamp(0.875rem, 2.5vw, 1.25rem); border-radius: var(--radius-md); margin-top: clamp(0.875rem, 2.5vw, 1.25rem);">
                    <div class="input-field" style="grid-column: 1 / -1;">
                        <label style="font-size: clamp(1rem, 2.2vw, 1.05rem); color: #2e7d32; font-weight: 600;">üí∞ Enerji Maliyeti ve ROI Parametreleri</label>
                        <small style="display: block; margin-top: 5px; color: #666; font-size: clamp(0.85rem, 1.8vw, 0.9rem);">Geri √∂deme s√ºresi hesaplamasƒ± i√ßin enerji maliyeti ve √ßalƒ±≈üma saati bilgilerini girin.</small>
                    </div>
                    <div class="input-field">
                        <label>‚ö° Elektrik Birim Fiyatƒ± (TL/kWh)</label>
                        <input type="number" id="electricityPrice" value="3.5" step="0.1" min="0" placeholder="√ñrn: 3.5">
                        <small style="color: #666; font-size: clamp(0.8rem, 1.6vw, 0.85rem); display: block; margin-top: 4px;">Ortalama sanayi: 3-4 TL/kWh</small>
                    </div>
                    <div class="input-field">
                        <label>‚è±Ô∏è Yƒ±llƒ±k √áalƒ±≈üma Saati</label>
                        <input type="number" id="operatingHours" value="6000" step="100" min="0" placeholder="√ñrn: 6000">
                        <small style="color: #666; font-size: clamp(0.8rem, 1.6vw, 0.85rem); display: block; margin-top: 4px;">3 vardiya: 7000-8000 saat/yƒ±l</small>
                    </div>
                </div>

                <!-- Aktif G√º√ß Bazlƒ± Hesaplama i√ßin Ek Alan -->
                <div id="powerBasedFields" style="display: none; margin-top: 20px;">
                    <div class="info">
                        <strong>‚ÑπÔ∏è Aktif G√º√ß Bazlƒ± Hesaplama Modu</strong><br>
                        Bu modda sadece toplam aktif g√º√ß deƒüerini girerek, motor ve cihaz eklemeden hƒ±zlƒ± kompanzasyon hesabƒ± yapabilirsiniz.
                        <strong>Saha arƒ±zalarƒ±nda ideal!</strong> üì±
                    </div>

                    <!-- Mevcut Cos œÜ Bilgisi Var mƒ±? -->
                    <div class="input-group" style="margin-top: 15px; background: #fff9e6; padding: 15px; border-radius: 8px;">
                        <div class="input-field" style="grid-column: 1 / -1;">
                            <label style="font-size: 1em; color: #667eea;">üìä Mevcut Cos œÜ Durumu</label>
                            <select id="powerBasedCosPhiMode" onchange="togglePowerBasedCosPhiMode()" style="font-size: 0.95em; padding: 10px;">
                                <option value="known">‚úÖ Mevcut Cos œÜ Biliniyor (Sahada √∂l√ßt√ºm)</option>
                                <option value="unknown">‚ùì Mevcut Cos œÜ Bilinmiyor (Tahmin et)</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group" style="margin-top: 15px;">
                        <div class="input-field">
                            <label>üìà Toplam Aktif G√º√ß (kW)</label>
                            <input type="number" id="totalActivePowerInput" placeholder="√ñrn: 150" step="0.1">
                        </div>
                        <div class="input-field" id="powerBasedCurrentPFField">
                            <label>üìä Mevcut Cos œÜ <span style="color: #28a745;">(√ñl√ß√ºlen)</span></label>
                            <input type="number" id="powerBasedCurrentPF" value="0.7" step="0.01" min="0" max="1" placeholder="√ñrn: 0.7">
                        </div>
                        <div class="input-field" id="powerBasedEstimatedPFField" style="display: none;">
                            <label>üîÆ Tahmini Mevcut Cos œÜ</label>
                            <select id="powerBasedEstimatedPF">
                                <option value="0.5">√áok D√º≈ü√ºk (0.50) - Kompanzasyonsuz End√ºktif Y√ºk</option>
                                <option value="0.6">D√º≈ü√ºk (0.60) - Motor Aƒüƒ±rlƒ±klƒ±</option>
                                <option value="0.7" selected>Orta (0.70) - Karƒ±≈üƒ±k Y√ºk</option>
                                <option value="0.8">ƒ∞yi (0.80) - Az Kompanzasyonlu</option>
                                <option value="0.85">√áok ƒ∞yi (0.85) - Kƒ±smi Kompanzasyonlu</option>
                            </select>
                        </div>
                        <div class="input-field">
                            <label>üåä Harmonik Y√ºk√º</label>
                            <select id="powerBasedHarmonicLoad">
                                <option value="0">Yok/D√º≈ü√ºk (THD < 15%) - Sadece Motorlar</option>
                                <option value="20">Orta (THD 15-25%) - Az ƒ∞nvert√∂r</option>
                                <option value="35" selected>Y√ºksek (THD 25-40%) - ƒ∞nvert√∂rler Var</option>
                                <option value="50">√áok Y√ºksek (THD > 40%) - √áok ƒ∞nvert√∂r/VFD</option>
                            </select>
                        </div>
                    </div>

                    <!-- Reaktif G√º√ß Giri≈üi (Opsiyonel - Cos bilinmiyorsa) -->
                    <div id="powerBasedReactiveField" style="display: none; margin-top: 15px;">
                        <div class="warning" style="background: #e8f5e9; border-color: #4caf50;">
                            <strong>üí° ƒ∞PUCU:</strong> Eƒüer saya√ßtan reaktif g√º√ß (kVAr) deƒüerini okuyabiliyorsanƒ±z,
                            buraya girebilirsiniz. Daha doƒüru hesaplama yapar!
                        </div>
                        <div class="input-group" style="margin-top: 10px;">
                            <div class="input-field">
                                <label>üìâ Mevcut Reaktif G√º√ß (kVAr) <span style="color: #999;">(Opsiyonel)</span></label>
                                <input type="number" id="currentReactivePowerInput" placeholder="Saya√ßtan okunan deƒüer" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Motor Ekle -->
            <div class="section">
                <h2>üîå Motor Ekle</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label>Motor Adƒ±</label>
                        <input type="text" id="motorName" placeholder="√ñrn: Motor 1">
                    </div>
                    <div class="input-field">
                        <label>Motor G√ºc√º (kW)</label>
                        <input type="number" id="motorPower" placeholder="√ñrn: 15">
                    </div>
                    <div class="input-field">
                        <label>Motor Adedi</label>
                        <input type="number" id="motorCount" value="1" min="1" placeholder="√ñrn: 2">
                    </div>
                    <div class="input-field">
                        <label>Motor Cos œÜ</label>
                        <input type="number" id="motorCosPhi" value="0.85" step="0.01" min="0" max="1">
                    </div>
                    <div class="input-field">
                        <label>Motor Verimi (%)</label>
                        <input type="number" id="motorEfficiency" value="90" min="0" max="100" placeholder="√ñrn: 90">
                    </div>
                    <div class="input-field">
                        <label>√áalƒ±≈üma Rejimi</label>
                        <select id="motorRegime">
                            <option value="continuous">S√ºrekli</option>
                            <option value="intermittent">Aralƒ±klƒ±</option>
                            <option value="heavy">Aƒüƒ±r Y√ºk</option>
                        </select>
                    </div>
                    <div class="input-field">
                        <label>Y√ºk Fakt√∂r√º (%)</label>
                        <input type="number" id="motorLoadFactor" value="75" min="0" max="100" placeholder="√ñrn: 75">
                    </div>
                    <div class="input-field">
                        <label>ƒ∞nvert√∂r/SS ile Kontrol</label>
                        <select id="motorControlDevice">
                            <option value="none">DOL (Direkt)</option>
                            <option value="inverter">ƒ∞nvert√∂r ile</option>
                            <option value="softstarter">Soft Starter ile</option>
                        </select>
                    </div>
                </div>
                <button onclick="addMotor()">‚ûï Motor Ekle</button>
                <div class="equipment-list" id="motorList"></div>
            </div>

            <!-- ƒ∞nvert√∂r/Soft Starter Ekle -->
            <div class="section">
                <h2>üìü ƒ∞nvert√∂r / Soft Starter Ekle</h2>
                <div class="input-group">
                    <div class="input-field">
                        <label>Cihaz Tipi</label>
                        <select id="deviceType" onchange="updateDeviceDefaults()">
                            <option value="inverter">ƒ∞nvert√∂r (VFD)</option>
                            <option value="softstarter">Soft Starter</option>
                        </select>
                    </div>
                    <div class="input-field">
                        <label>Cihaz Adƒ±</label>
                        <input type="text" id="deviceName" placeholder="√ñrn: ƒ∞nvert√∂r 1">
                    </div>
                    <div class="input-field">
                        <label>Cihaz G√ºc√º (kW)</label>
                        <input type="number" id="devicePower" placeholder="√ñrn: 22">
                    </div>
                    <div class="input-field">
                        <label>Adedi</label>
                        <input type="number" id="deviceCount" value="1" min="1">
                    </div>
                    <div class="input-field">
                        <label>THD (%) - Harmonik Bozulmasƒ±</label>
                        <input type="number" id="deviceTHD" value="35" placeholder="ƒ∞nvert√∂r: 30-50, SS: 5-15">
                    </div>
                    <div class="input-field">
                        <label>√áalƒ±≈üma Frekansƒ± (%)</label>
                        <input type="number" id="deviceFrequency" value="80" min="0" max="100" placeholder="50Hz bazlƒ± %">
                    </div>
                    <div class="input-field">
                        <label>Baƒülƒ± Motor Se√ß</label>
                        <button class="link-btn" onclick="openMotorSelector()">üîó Motor Baƒüla</button>
                    </div>
                </div>
                <button onclick="addDevice()">‚ûï Cihaz Ekle</button>
                <div class="equipment-list" id="deviceList"></div>
            </div>

            <!-- Gruplama -->
            <div class="section">
                <h2>üìä Ekipman Gruplama</h2>
                <p style="margin-bottom: 15px; color: #666;">Ekipmanlarƒ± grup bazƒ±nda organize edin (opsiyonel)</p>
                <div class="input-group">
                    <div class="input-field">
                        <label>Grup Adƒ±</label>
                        <input type="text" id="groupName" placeholder="√ñrn: √úretim Hattƒ± 1">
                    </div>
                </div>
                <button onclick="createGroup()">‚ûï Grup Olu≈ütur</button>
                <div id="groupsList"></div>
            </div>

            <!-- Kaydet/Y√ºkle B√∂l√ºm√º -->
            <div class="save-load-section">
                <h3>üíæ Veri Y√∂netimi</h3>
                <div class="action-buttons">
                    <button onclick="saveToLocalStorage()">üíæ Tarayƒ±cƒ±ya Kaydet</button>
                    <button onclick="loadFromLocalStorage()">üìÇ Tarayƒ±cƒ±dan Y√ºkle</button>
                    <button onclick="exportToJSON()">üì• JSON ƒ∞ndir</button>
                    <label for="jsonFileInput" class="file-label">üì§ JSON Y√ºkle</label>
                    <input type="file" id="jsonFileInput" class="file-input" accept=".json" onchange="importFromJSON(event)">
                </div>
            </div>

            <!-- Hesapla Butonu -->
            <div class="action-buttons">
                <button class="success" onclick="calculate()" style="font-size: 1.2em; padding: 15px 40px;">
                    üßÆ Kompanzasyon Hesapla
                </button>
                <button class="secondary" onclick="resetAll()">
                    üîÑ T√ºm√ºn√º Sƒ±fƒ±rla
                </button>
            </div>

            <!-- Sonu√ßlar -->
            <div id="results"></div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Loading Overlay and Spinner -->
    <div id="loadingOverlay" class="loading-overlay"></div>
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">‚ö° Hesaplama yapƒ±lƒ±yor...</div>
    </div>

    <!-- Modal for Motor Selection -->
    <div id="motorSelectorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeMotorSelector()">&times;</span>
                <h2>Motor Se√ßimi</h2>
            </div>
            <div id="motorSelectionList"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="confirmMotorSelection()">‚úì Se√ßimi Onayla</button>
                <button class="secondary" onclick="closeMotorSelector()">ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <script>
        let motors = [];
        let devices = [];
        let groups = [];
        let selectedMotorForLink = null;
        let currentDeviceForLink = null;
        let powerChart = null;
        let harmonicChart = null;
        let lastResults = null;

        // localStorage kullanƒ±labilir mi kontrol et
        function isLocalStorageAvailable() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Sayfa y√ºklendiƒüinde otomatik y√ºkleme
        window.addEventListener('load', () => {
            try {
                if (isLocalStorageAvailable()) {
                    const savedData = localStorage.getItem('kompanzasyonData');
                    if (savedData) {
                        const autoLoad = confirm('Kaydedilmi≈ü veri bulundu. Y√ºklemek ister misiniz?');
                        if (autoLoad) {
                            loadFromLocalStorage();
                        }
                    }
                }
            } catch (e) {
                console.warn('localStorage kullanƒ±lamƒ±yor:', e);
            }
            updateDesignMode(); // Ba≈ülangƒ±√ßta modu g√ºncelle
        });

        // Tasarƒ±m modu deƒüi≈ütiƒüinde
        function updateDesignMode() {
            const mode = document.getElementById('designMode').value;
            const currentPFField = document.getElementById('currentPFField');
            const currentPFInput = document.getElementById('currentPowerFactor');
            const powerBasedFields = document.getElementById('powerBasedFields');
            const modeDescription = document.getElementById('modeDescription');

            // G√ºvenli section se√ßimi
            const sections = document.querySelectorAll('.section');
            if (sections.length < 4) {
                console.error('Yeterli section bulunamadƒ±');
                return;
            }
            const motorSection = sections[1]; // Motor b√∂l√ºm√º
            const deviceSection = sections[2]; // Cihaz b√∂l√ºm√º
            const groupSection = sections[3]; // Grup b√∂l√ºm√º

            if (mode === 'new') {
                // Sƒ±fƒ±rdan yeni sistem
                modeDescription.innerHTML = 'üÜï Mevcut Cos œÜ deƒüerini dikkate almadan, sadece motorlar ve cihazlar √ºzerinden tam sistem tasarƒ±mƒ± yapƒ±lƒ±r.';
                currentPFInput.disabled = true;
                currentPFInput.style.opacity = '0.5';
                powerBasedFields.style.display = 'none';
                motorSection.style.display = 'block';
                deviceSection.style.display = 'block';
                groupSection.style.display = 'block';
                currentPFField.querySelector('label').innerHTML = 'Mevcut Cos œÜ <span style="color: #999;">(Opsiyonel - Yeni tasarƒ±mda kullanƒ±lmaz)</span>';
            } else if (mode === 'upgrade') {
                // Mevcut sistemi geli≈ütirme
                modeDescription.innerHTML = 'üîÑ Mevcut Cos œÜ deƒüeri kullanƒ±larak, hedefe ula≈ümak i√ßin <strong>sadece eksik olan kondansat√∂r g√ºc√º</strong> hesaplanƒ±r.';
                currentPFInput.disabled = false;
                currentPFInput.style.opacity = '1';
                powerBasedFields.style.display = 'none';
                motorSection.style.display = 'block';
                deviceSection.style.display = 'block';
                groupSection.style.display = 'block';
                currentPFField.querySelector('label').innerHTML = 'Mevcut Cos œÜ <span style="color: #28a745;">(Zorunlu)</span>';
            } else if (mode === 'powerBased') {
                // Aktif g√º√ß bazlƒ±
                modeDescription.innerHTML = '‚ö° Sadece toplam aktif g√º√ß deƒüeri ile hƒ±zlƒ± kompanzasyon hesabƒ±. Motor ve cihaz eklemeye gerek yok. <strong>Saha arƒ±zalarƒ± i√ßin ideal!</strong>';
                currentPFInput.disabled = true;
                currentPFInput.style.opacity = '0.5';
                powerBasedFields.style.display = 'block';
                motorSection.style.display = 'none';
                deviceSection.style.display = 'none';
                groupSection.style.display = 'none';
                currentPFField.querySelector('label').innerHTML = 'Mevcut Cos œÜ <span style="color: #999;">(Kullanƒ±lmayacak)</span>';
            }
        }

        // Aktif g√º√ß bazlƒ± Cos œÜ modu deƒüi≈üimi
        function togglePowerBasedCosPhiMode() {
            const mode = document.getElementById('powerBasedCosPhiMode').value;
            const currentPFField = document.getElementById('powerBasedCurrentPFField');
            const estimatedPFField = document.getElementById('powerBasedEstimatedPFField');
            const reactiveField = document.getElementById('powerBasedReactiveField');

            if (mode === 'known') {
                // Cos œÜ biliniyor
                currentPFField.style.display = 'block';
                estimatedPFField.style.display = 'none';
                reactiveField.style.display = 'none';
            } else {
                // Cos œÜ bilinmiyor
                currentPFField.style.display = 'none';
                estimatedPFField.style.display = 'block';
                reactiveField.style.display = 'block';
            }
        }

        function addMotor() {
            const name = document.getElementById('motorName').value || `Motor ${motors.length + 1}`;
            const power = parseFloat(document.getElementById('motorPower').value);
            const count = parseInt(document.getElementById('motorCount').value) || 1;
            const cosPhi = parseFloat(document.getElementById('motorCosPhi').value);
            const efficiency = parseFloat(document.getElementById('motorEfficiency').value);
            const regime = document.getElementById('motorRegime').value;
            const loadFactor = parseFloat(document.getElementById('motorLoadFactor').value);
            const controlDevice = document.getElementById('motorControlDevice').value;

            if (!power || power <= 0) {
                showNotification('L√ºtfen ge√ßerli bir motor g√ºc√º girin!', 'error');
                return;
            }

            if (cosPhi < 0 || cosPhi > 1) {
                showNotification('Cos œÜ deƒüeri 0-1 arasƒ±nda olmalƒ±dƒ±r!', 'error');
                return;
            }

            if (efficiency < 0 || efficiency > 100) {
                showNotification('Verim deƒüeri 0-100 arasƒ±nda olmalƒ±dƒ±r!', 'error');
                return;
            }

            const motorId = 'motor_' + Date.now();
            motors.push({
                id: motorId,
                name,
                power,
                count,
                cosPhi,
                efficiency,
                regime,
                loadFactor,
                controlDevice,
                linkedDevice: null,
                type: 'motor'
            });
            updateMotorList();
            clearMotorInputs();
            showNotification(`${name} ba≈üarƒ±yla eklendi`, 'success');
        }

        function addDevice() {
            const type = document.getElementById('deviceType').value;
            const name = document.getElementById('deviceName').value || `${type === 'inverter' ? 'ƒ∞nvert√∂r' : 'Soft Starter'} ${devices.length + 1}`;
            const power = parseFloat(document.getElementById('devicePower').value);
            const count = parseInt(document.getElementById('deviceCount').value) || 1;
            const thd = parseFloat(document.getElementById('deviceTHD').value);
            const frequency = parseFloat(document.getElementById('deviceFrequency').value);

            if (!power || power <= 0) {
                showNotification('L√ºtfen ge√ßerli bir cihaz g√ºc√º girin!', 'error');
                return;
            }

            if (thd < 0 || thd > 100) {
                showNotification('THD deƒüeri 0-100 arasƒ±nda olmalƒ±dƒ±r!', 'error');
                return;
            }

            const deviceId = 'device_' + Date.now();
            devices.push({
                id: deviceId,
                name,
                power,
                count,
                thd,
                frequency,
                deviceType: type,
                linkedMotors: [],
                type: 'device'
            });
            updateDeviceList();
            clearDeviceInputs();
            showNotification(`${name} ba≈üarƒ±yla eklendi`, 'success');
        }

        function updateDeviceDefaults() {
            const type = document.getElementById('deviceType').value;
            if (type === 'inverter') {
                document.getElementById('deviceTHD').value = 35;
                document.getElementById('deviceTHD').placeholder = '30-50';
            } else {
                document.getElementById('deviceTHD').value = 10;
                document.getElementById('deviceTHD').placeholder = '5-15';
            }
        }

        function updateMotorList() {
            const list = document.getElementById('motorList');
            list.innerHTML = motors.map((motor, index) => {
                const linkedDevice = motor.linkedDevice ? devices.find(d => d.id === motor.linkedDevice) : null;
                const controlText = motor.controlDevice === 'none' ? 'DOL' :
                                  motor.controlDevice === 'inverter' ? 'ƒ∞nvert√∂r ile' : 'Soft Starter ile';
                return `
                <div class="equipment-item">
                    <div class="equipment-details">
                        <strong>${motor.name}</strong> -
                        ${motor.power} kW √ó ${motor.count} adet |
                        Cos œÜ: ${motor.cosPhi} |
                        Verim: ${motor.efficiency}% |
                        Y√ºk: ${motor.loadFactor}% |
                        Kontrol: ${controlText}
                        ${linkedDevice ? `<span class="connected-badge">üîó Baƒülƒ±: ${linkedDevice.name}</span>` : ''}
                        <br><small style="color: #666;">Rejim: ${motor.regime === 'continuous' ? 'S√ºrekli' : motor.regime === 'intermittent' ? 'Aralƒ±klƒ±' : 'Aƒüƒ±r Y√ºk'}</small>
                    </div>
                    <div>
                        ${linkedDevice ?
                            `<button class="unlink-btn" onclick="unlinkMotorFromDevice(${index})">üîì Baƒülantƒ±yƒ± Kes</button>` :
                            `<button class="link-btn" onclick="linkMotorToDevice(${index})">üîó Cihaz Baƒüla</button>`
                        }
                        <button class="remove-btn" onclick="removeMotor(${index})">‚ùå Sil</button>
                    </div>
                </div>
            `}).join('');
        }

        function updateDeviceList() {
            const list = document.getElementById('deviceList');
            list.innerHTML = devices.map((device, index) => {
                const linkedMotorNames = device.linkedMotors.map(motorId => {
                    const motor = motors.find(m => m.id === motorId);
                    return motor ? motor.name : '';
                }).filter(n => n).join(', ');

                return `
                <div class="equipment-item">
                    <div class="equipment-details">
                        <strong>${device.name}</strong> -
                        ${device.power} kW √ó ${device.count} adet |
                        THD: ${device.thd}% |
                        Frekans: ${device.frequency}% |
                        Tip: ${device.deviceType === 'inverter' ? 'ƒ∞nvert√∂r (VFD)' : 'Soft Starter'}
                        ${linkedMotorNames ? `<span class="connected-badge">üîó Baƒülƒ± Motorlar: ${linkedMotorNames}</span>` : ''}
                    </div>
                    <button class="remove-btn" onclick="removeDevice(${index})">‚ùå Sil</button>
                </div>
            `}).join('');
        }

        function removeMotor(index) {
            const motor = motors[index];
            // Baƒülƒ± cihazdan baƒülantƒ±yƒ± kaldƒ±r
            if (motor.linkedDevice) {
                const device = devices.find(d => d.id === motor.linkedDevice);
                if (device) {
                    device.linkedMotors = device.linkedMotors.filter(id => id !== motor.id);
                }
            }
            motors.splice(index, 1);
            updateMotorList();
            updateDeviceList();
        }

        function removeDevice(index) {
            const device = devices[index];
            // Baƒülƒ± motorlardan baƒülantƒ±yƒ± kaldƒ±r
            device.linkedMotors.forEach(motorId => {
                const motor = motors.find(m => m.id === motorId);
                if (motor) {
                    motor.linkedDevice = null;
                }
            });
            devices.splice(index, 1);
            updateMotorList();
            updateDeviceList();
        }

        function linkMotorToDevice(motorIndex) {
            if (devices.length === 0) {
                showNotification('√ñnce bir ƒ∞nvert√∂r veya Soft Starter ekleyin!', 'error');
                return;
            }
            currentDeviceForLink = motors[motorIndex];
            openDeviceSelector();
        }

        function unlinkMotorFromDevice(motorIndex) {
            const motor = motors[motorIndex];
            if (motor.linkedDevice) {
                const device = devices.find(d => d.id === motor.linkedDevice);
                if (device) {
                    device.linkedMotors = device.linkedMotors.filter(id => id !== motor.id);
                }
                motor.linkedDevice = null;
            }
            updateMotorList();
            updateDeviceList();
        }

        function openMotorSelector() {
            if (motors.length === 0) {
                showNotification('√ñnce motor ekleyin!', 'error');
                return;
            }

            const modal = document.getElementById('motorSelectorModal');
            const list = document.getElementById('motorSelectionList');

            list.innerHTML = motors.map((motor, index) => `
                <div class="connection-item" onclick="selectMotorForLink('${motor.id}')" id="motor-select-${motor.id}">
                    <strong>${motor.name}</strong> - ${motor.power} kW √ó ${motor.count} adet
                    ${motor.linkedDevice ? '<span class="connected-badge">Zaten Baƒülƒ±</span>' : ''}
                </div>
            `).join('');

            modal.style.display = 'block';
        }

        function openDeviceSelector() {
            const modal = document.getElementById('motorSelectorModal');
            const list = document.getElementById('motorSelectionList');

            list.innerHTML = devices.map((device, index) => `
                <div class="connection-item" onclick="selectDeviceForLink('${device.id}')" id="device-select-${device.id}">
                    <strong>${device.name}</strong> - ${device.power} kW (${device.deviceType === 'inverter' ? 'ƒ∞nvert√∂r' : 'Soft Starter'})
                </div>
            `).join('');

            modal.style.display = 'block';
        }

        function selectMotorForLink(motorId) {
            selectedMotorForLink = motorId;
            document.querySelectorAll('.connection-item').forEach(el => el.classList.remove('selected'));
            document.getElementById('motor-select-' + motorId).classList.add('selected');
        }

        function selectDeviceForLink(deviceId) {
            if (!currentDeviceForLink) return;

            const motor = currentDeviceForLink;
            const device = devices.find(d => d.id === deviceId);

            if (motor.linkedDevice) {
                const oldDevice = devices.find(d => d.id === motor.linkedDevice);
                if (oldDevice) {
                    oldDevice.linkedMotors = oldDevice.linkedMotors.filter(id => id !== motor.id);
                }
            }

            motor.linkedDevice = deviceId;
            if (!device.linkedMotors.includes(motor.id)) {
                device.linkedMotors.push(motor.id);
            }

            // Motor kontrol√º otomatik g√ºncelle
            motor.controlDevice = device.deviceType === 'inverter' ? 'inverter' : 'softstarter';

            updateMotorList();
            updateDeviceList();
            closeMotorSelector();
            currentDeviceForLink = null;
        }

        function confirmMotorSelection() {
            if (!selectedMotorForLink) {
                showNotification('L√ºtfen bir motor se√ßin!', 'error');
                return;
            }
            closeMotorSelector();
        }

        function closeMotorSelector() {
            document.getElementById('motorSelectorModal').style.display = 'none';
            selectedMotorForLink = null;
            currentDeviceForLink = null;
        }

        function clearMotorInputs() {
            document.getElementById('motorName').value = '';
            document.getElementById('motorPower').value = '';
            document.getElementById('motorCount').value = '1';
            document.getElementById('motorEfficiency').value = '90';
            document.getElementById('motorLoadFactor').value = '75';
            document.getElementById('motorControlDevice').value = 'none';
        }

        function clearDeviceInputs() {
            document.getElementById('deviceName').value = '';
            document.getElementById('devicePower').value = '';
            document.getElementById('deviceCount').value = '1';
            document.getElementById('deviceFrequency').value = '80';
        }

        function createGroup() {
            const groupName = document.getElementById('groupName').value;
            if (!groupName) {
                showNotification('L√ºtfen grup adƒ± girin!', 'error');
                return;
            }

            groups.push({ name: groupName, items: [] });
            updateGroupsList();
            document.getElementById('groupName').value = '';
            showNotification(`Grup "${groupName}" olu≈üturuldu`, 'success');
        }

        function updateGroupsList() {
            const groupsList = document.getElementById('groupsList');
            if (groups.length === 0) return;

            groupsList.innerHTML = groups.map((group, index) => `
                <div class="group-section">
                    <h3>üìÅ ${group.name}</h3>
                    <p style="color: #666; margin-bottom: 10px;">Bu grup i√ßin ekipman eklenebilir (manuel d√ºzenleme i√ßin)</p>
                    <button class="remove-btn" onclick="removeGroup(${index})">üóëÔ∏è Grubu Sil</button>
                </div>
            `).join('');
        }

        function removeGroup(index) {
            groups.splice(index, 1);
            updateGroupsList();
        }

        function calculate() {
            const designMode = document.getElementById('designMode').value;
            const systemVoltage = parseFloat(document.getElementById('systemVoltage').value);
            const systemFrequency = parseFloat(document.getElementById('systemFrequency').value);
            const targetPF = parseFloat(document.getElementById('targetPowerFactor').value);

            // Mod bazlƒ± validasyon
            if (designMode === 'powerBased') {
                // Aktif g√º√ß bazlƒ± hesaplama
                const totalActivePowerInput = parseFloat(document.getElementById('totalActivePowerInput').value);
                const powerBasedHarmonicLoad = parseFloat(document.getElementById('powerBasedHarmonicLoad').value);
                const cosPhiMode = document.getElementById('powerBasedCosPhiMode').value;

                if (!totalActivePowerInput || totalActivePowerInput <= 0) {
                    showNotification('L√ºtfen toplam aktif g√º√ß deƒüerini girin!', 'error');
                    return;
                }

                let powerBasedCurrentPF;
                let currentReactivePowerDirect = null;

                if (cosPhiMode === 'known') {
                    // Cos œÜ biliniyor
                    powerBasedCurrentPF = parseFloat(document.getElementById('powerBasedCurrentPF').value);

                    if (powerBasedCurrentPF < 0 || powerBasedCurrentPF > 1) {
                        showNotification('Mevcut Cos œÜ deƒüeri 0-1 arasƒ±nda olmalƒ±dƒ±r!', 'error');
                        return;
                    }
                } else {
                    // Cos œÜ bilinmiyor - tahmin veya reaktif g√º√ß giri≈üi
                    const reactiveInput = parseFloat(document.getElementById('currentReactivePowerInput').value);

                    if (reactiveInput && reactiveInput > 0) {
                        // Reaktif g√º√ß girilmi≈ü, Cos œÜ hesapla
                        currentReactivePowerDirect = reactiveInput;
                        const apparentPower = Math.sqrt(Math.pow(totalActivePowerInput, 2) + Math.pow(reactiveInput, 2));
                        powerBasedCurrentPF = totalActivePowerInput / apparentPower;
                    } else {
                        // Tahmini Cos œÜ kullan
                        powerBasedCurrentPF = parseFloat(document.getElementById('powerBasedEstimatedPF').value);
                    }
                }

                if (targetPF < 0 || targetPF > 1) {
                    showNotification('Hedef Cos œÜ deƒüeri 0-1 arasƒ±nda olmalƒ±dƒ±r!', 'error');
                    return;
                }

                if (targetPF <= powerBasedCurrentPF) {
                    showNotification('Hedef Cos œÜ, mevcut Cos œÜ deƒüerinden b√ºy√ºk olmalƒ±dƒ±r!', 'error');
                    return;
                }

                showLoading();
                setTimeout(() => {
                    calculatePowerBased(totalActivePowerInput, powerBasedCurrentPF, targetPF, powerBasedHarmonicLoad, systemVoltage, systemFrequency, cosPhiMode, currentReactivePowerDirect);
                    hideLoading();
                    showNotification('Hesaplama tamamlandƒ±!', 'success');
                }, 200);
                return;
            }

            // Motor/Cihaz bazlƒ± hesaplama
            if (motors.length === 0 && devices.length === 0) {
                showNotification('L√ºtfen en az bir motor veya cihaz ekleyin!', 'error');
                return;
            }

            const currentPF = parseFloat(document.getElementById('currentPowerFactor').value);

            // Validasyonlar
            if (targetPF < 0 || targetPF > 1) {
                showNotification('Hedef Cos œÜ deƒüeri 0-1 arasƒ±nda olmalƒ±dƒ±r!', 'error');
                return;
            }

            if (designMode === 'upgrade') {
                // Geli≈ütirme modunda mevcut Cos œÜ kontrol et
                if (currentPF < 0 || currentPF > 1) {
                    showNotification('Mevcut Cos œÜ deƒüeri 0-1 arasƒ±nda olmalƒ±dƒ±r!', 'error');
                    return;
                }

                if (targetPF <= currentPF) {
                    showNotification('Hedef Cos œÜ, mevcut Cos œÜ deƒüerinden b√ºy√ºk olmalƒ±dƒ±r!', 'error');
                    return;
                }
            }

            showLoading();

            // Geli≈ümi≈ü motor analizi
            let totalActivePower = 0;
            let totalReactivePowerMotors = 0;
            let motorConnections = [];

            motors.forEach(motor => {
                // Ger√ßek g√º√ß t√ºketimi (y√ºk fakt√∂r√º ve verim dahil)
                const actualPower = motor.power * (motor.loadFactor / 100) * motor.count;
                const inputPower = actualPower / (motor.efficiency / 100);

                totalActivePower += inputPower;

                // Motor reaktif g√ºc√º
                const motorReactivePower = inputPower * Math.tan(Math.acos(motor.cosPhi));
                totalReactivePowerMotors += motorReactivePower;

                // Baƒülƒ± cihaz kontrol√º
                if (motor.linkedDevice) {
                    const linkedDevice = devices.find(d => d.id === motor.linkedDevice);
                    if (linkedDevice) {
                        motorConnections.push({
                            motor: motor,
                            device: linkedDevice,
                            powerReduction: linkedDevice.deviceType === 'inverter' ?
                                (100 - linkedDevice.frequency) / 100 : 0
                        });
                    }
                }
            });

            // Cihaz g√º√ß hesaplamalarƒ± (baƒülƒ± olmayanlar)
            devices.forEach(device => {
                const linkedMotorPower = device.linkedMotors.reduce((sum, motorId) => {
                    const motor = motors.find(m => m.id === motorId);
                    return motor ? sum + motor.power * motor.count : sum;
                }, 0);

                // Eƒüer baƒülƒ± motor yoksa cihaz g√ºc√ºn√º ekle
                if (linkedMotorPower === 0) {
                    totalActivePower += device.power * device.count;
                }
            });

            // Harmonik analizi (t√ºm cihazlar dahil)
            let totalTHD = 0;
            let totalHarmonicPower = 0;
            let harmonicDeviceCount = 0;

            devices.forEach(device => {
                const deviceTotalPower = device.power * device.count;
                totalTHD += device.thd * deviceTotalPower;
                totalHarmonicPower += deviceTotalPower;

                if (device.deviceType === 'inverter') {
                    harmonicDeviceCount += device.count;
                }
            });

            const avgTHD = totalHarmonicPower > 0 ? totalTHD / totalHarmonicPower : 0;

            // Reaktif g√º√ß hesaplama (mod bazlƒ±)
            let currentReactivePower, targetReactivePower, requiredCapacitivePower;
            let calculatedFromMotors = false;

            if (designMode === 'new') {
                // Sƒ±fƒ±rdan tasarƒ±m: Motorlarƒ±n kendi cos œÜ deƒüerlerinden hesapla
                currentReactivePower = totalReactivePowerMotors;
                targetReactivePower = totalActivePower * Math.tan(Math.acos(targetPF));
                requiredCapacitivePower = currentReactivePower - targetReactivePower;
                calculatedFromMotors = true;
            } else {
                // Geli≈ütirme: Mevcut Cos œÜ kullan
                currentReactivePower = totalActivePower * Math.tan(Math.acos(currentPF));
                targetReactivePower = totalActivePower * Math.tan(Math.acos(targetPF));
                requiredCapacitivePower = currentReactivePower - targetReactivePower;
            }

            // ƒ∞nvert√∂rler i√ßin ek reaktif g√º√ß d√ºzeltmesi
            motorConnections.forEach(conn => {
                if (conn.device.deviceType === 'inverter') {
                    // ƒ∞nvert√∂rler genellikle reaktif g√º√ß t√ºketir
                    const inverterReactivePower = conn.device.power * 0.3; // yakla≈üƒ±k %30
                    requiredCapacitivePower += inverterReactivePower * conn.device.count;
                }
            });

            // Harmonik kompanzasyonu i√ßin g√ºvenlik fakt√∂r√º
            // THD y√ºksekse kondansat√∂r g√ºc√ºne hafif g√ºvenlik marjƒ± ekle
            const harmonicFactor = avgTHD > 15 ? 1 + (avgTHD / 100) * 0.3 : 1;
            const adjustedCapacitivePower = requiredCapacitivePower * harmonicFactor;

            // Reakt√∂r gereksinimi (THD > 25% ise zorunlu)
            const reactorRequired = avgTHD > 25;
            const reactorPercentage = avgTHD > 40 ? 0.14 : avgTHD > 25 ? 0.07 : 0;
            const reactorPower = adjustedCapacitivePower * reactorPercentage;

            // Kademe sayƒ±sƒ± belirleme
            const stageCount = determineStageCount(totalActivePower, motors, devices);

            // Kademe boyutlarƒ±
            const stages = calculateStages(adjustedCapacitivePower, stageCount, motors, devices, avgTHD, systemVoltage);

            // Kondansat√∂r tipleri
            const capacitorType = avgTHD > 40 ? 'Anti-Harmonik Aƒüƒ±r Tip (14% Reakt√∂r)' :
                                avgTHD > 25 ? 'Anti-Harmonik (7% Reakt√∂r)' :
                                avgTHD > 15 ? 'Harmonik √ñnleyici (Filtreli)' : 'Standart';

            // Ana bara hesaplamalarƒ±
            const totalPanelCurrent = stages.reduce((sum, stage) => sum + stage.current, 0);
            const mainBusbarCrossSection = calculateCableCrossSection(totalPanelCurrent);
            const mainMCBRating = calculateMCBRating(totalPanelCurrent);

            displayResults({
                systemVoltage,
                systemFrequency,
                totalActivePower,
                currentPF: designMode === 'new' ? null : currentPF,
                targetPF,
                currentReactivePower,
                targetReactivePower,
                requiredCapacitivePower,
                adjustedCapacitivePower,
                avgTHD,
                reactorRequired,
                reactorPower,
                reactorPercentage: reactorPercentage * 100,
                capacitorType,
                stageCount,
                stages,
                motorCount: motors.reduce((sum, m) => sum + m.count, 0),
                deviceCount: devices.reduce((sum, d) => sum + d.count, 0),
                connectedMotors: motorConnections.length,
                totalHarmonicPower,
                motorConnections,
                totalPanelCurrent,
                mainBusbarCrossSection,
                mainMCBRating,
                designMode,
                calculatedFromMotors
            });
        }

        // Aktif g√º√ß bazlƒ± hƒ±zlƒ± hesaplama
        function calculatePowerBased(totalActivePower, currentPF, targetPF, avgTHD, systemVoltage, systemFrequency, cosPhiMode, currentReactivePowerDirect) {
            // Reaktif g√º√ß hesaplama
            let currentReactivePower;

            if (currentReactivePowerDirect !== null && currentReactivePowerDirect > 0) {
                // Direkt reaktif g√º√ß girilmi≈ü
                currentReactivePower = currentReactivePowerDirect;
            } else {
                // Cos œÜ'den hesapla
                currentReactivePower = totalActivePower * Math.tan(Math.acos(currentPF));
            }

            const targetReactivePower = totalActivePower * Math.tan(Math.acos(targetPF));
            let requiredCapacitivePower = currentReactivePower - targetReactivePower;

            // Harmonik kompanzasyonu i√ßin g√ºvenlik fakt√∂r√º
            const harmonicFactor = avgTHD > 15 ? 1 + (avgTHD / 100) * 0.3 : 1;
            const adjustedCapacitivePower = requiredCapacitivePower * harmonicFactor;

            // Reakt√∂r gereksinimi
            const reactorRequired = avgTHD > 25;
            const reactorPercentage = avgTHD > 40 ? 14 : avgTHD > 25 ? 7 : 0;
            const reactorPower = adjustedCapacitivePower * (reactorPercentage / 100);

            // Kondansat√∂r tipi
            const capacitorType = avgTHD > 40 ? 'Anti-Harmonik Aƒüƒ±r Tip (14% Reakt√∂r)' :
                                avgTHD > 25 ? 'Anti-Harmonik (7% Reakt√∂r)' :
                                avgTHD > 15 ? 'Harmonik √ñnleyici (Filtreli)' : 'Standart';

            // Maliyet ve tasarruf hesaplamalarƒ±
            const estimatedCost = calculateEstimatedCost(adjustedCapacitivePower, reactorRequired, reactorPercentage);
            const energySavings = calculateEnergySavings(totalActivePower, currentPF, targetPF);
            const paybackPeriod = calculatePaybackPeriod(estimatedCost, energySavings);

            displayPowerBasedResults({
                systemVoltage,
                systemFrequency,
                totalActivePower,
                currentPF,
                targetPF,
                currentReactivePower,
                targetReactivePower,
                requiredCapacitivePower,
                adjustedCapacitivePower,
                avgTHD,
                reactorRequired,
                reactorPower,
                reactorPercentage,
                capacitorType,
                cosPhiMode: cosPhiMode,
                usedReactivePowerDirect: currentReactivePowerDirect !== null && currentReactivePowerDirect > 0,
                estimatedCost,
                energySavings,
                paybackPeriod
            });
        }

        // Tahmini maliyet hesaplama
        function calculateEstimatedCost(capacitivePower, reactorRequired, reactorPercentage) {
            // Kondansat√∂r maliyeti (kVAr ba≈üƒ±na ortalama fiyat - TL)
            const capacitorUnitCost = reactorRequired ?
                (reactorPercentage > 10 ? 350 : 280) : // Anti-harmonik
                220; // Standart

            const capacitorCost = capacitivePower * capacitorUnitCost;

            // Panel, kontrol ve montaj maliyeti (%40-50 ek)
            const panelAndInstallation = capacitorCost * 0.45;

            // Reakt√∂r maliyeti
            const reactorCost = reactorRequired ? (capacitivePower * reactorPercentage / 100) * 400 : 0;

            const totalCost = capacitorCost + panelAndInstallation + reactorCost;

            return {
                capacitorCost,
                reactorCost,
                panelAndInstallation,
                totalCost
            };
        }

        // Enerji tasarrufu hesaplama
        function calculateEnergySavings(activePower, currentPF, targetPF) {
            // Kullanƒ±cƒ± giri≈ülerinden parametreleri al
            const operatingHours = parseFloat(document.getElementById('operatingHours').value) || 6000;
            const electricityPrice = parseFloat(document.getElementById('electricityPrice').value) || 3.5;

            // 1) Aktif g√º√ß kaybƒ± tasarrufu
            // Transformat√∂r ve hat kayƒ±plarƒ± - G√∂r√ºn√ºr g√º√ß ile orantƒ±lƒ±
            const currentApparentPower = activePower / currentPF;
            const targetApparentPower = activePower / targetPF;

            // Hat kaybƒ± yakla≈üƒ±k olarak g√∂r√ºn√ºr g√ºc√ºn %2-3'√º kadar (transformat√∂r dahil)
            const lossPercentage = 0.025; // %2.5
            const currentTotalLosses = currentApparentPower * lossPercentage;
            const targetTotalLosses = targetApparentPower * lossPercentage;
            const lossReduction = currentTotalLosses - targetTotalLosses;

            // Yƒ±llƒ±k aktif kayƒ±p tasarrufu
            const activeLossSavings = lossReduction * operatingHours * electricityPrice;

            // 2) Reaktif enerji ceza tasarrufu (TEDA≈û kurallarƒ±na g√∂re)
            // Mevcut durum
            const currentReactivePower = activePower * Math.tan(Math.acos(currentPF));
            const currentReactiveEnergy = currentReactivePower * operatingHours; // kVArh/yƒ±l
            const currentActiveEnergy = activePower * operatingHours; // kWh/yƒ±l

            // TEDA≈û: Reaktif/Aktif oranƒ± > %20 ise ceza
            const allowedReactiveRatio = 0.20; // %20
            const allowedReactiveEnergy = currentActiveEnergy * allowedReactiveRatio;
            const excessCurrentReactive = Math.max(0, currentReactiveEnergy - allowedReactiveEnergy);

            // Hedef durum
            const targetReactivePower = activePower * Math.tan(Math.acos(targetPF));
            const targetReactiveEnergy = targetReactivePower * operatingHours;
            const excessTargetReactive = Math.max(0, targetReactiveEnergy - allowedReactiveEnergy);

            // Cezadan ka√ßƒ±nƒ±lan reaktif enerji
            const penaltyAvoided = excessCurrentReactive - excessTargetReactive;

            // Reaktif enerji ceza √ºcreti (Aktif enerjinin fiyatƒ±nƒ±n yakla≈üƒ±k %60'ƒ± kadar)
            const reactivePenaltyRate = electricityPrice * 0.60; // TL/kVArh
            const reactivePenaltySavings = penaltyAvoided * reactivePenaltyRate;

            // 3) Kapasite artƒ±≈üƒ± (Transformat√∂r ve kablo kapasitesi)
            // Cos œÜ d√ºzelince aynƒ± transformat√∂r ile daha fazla aktif g√º√ß ta≈üƒ±nabilir
            const capacityIncrease = activePower * ((1/currentPF) - (1/targetPF));

            // 4) G√º√ß √ßarpanƒ± d√ºzeltme (Elektrik faturasƒ±nda indirim)
            // Bazƒ± santraller cos œÜ > 0.90 olduƒüunda indirim yapƒ±yor
            let powerFactorBonus = 0;
            if (targetPF >= 0.95 && currentPF < 0.90) {
                // Faturaya %2-5 indirim uygulanabilir
                powerFactorBonus = currentActiveEnergy * electricityPrice * 0.03; // %3 kabul
            }

            // Toplam yƒ±llƒ±k tasarruf
            const annualSavings = activeLossSavings + reactivePenaltySavings + powerFactorBonus;
            const monthlySavings = annualSavings / 12;

            return {
                lossReduction: lossReduction.toFixed(2),
                activeLossSavings: activeLossSavings.toFixed(2),
                currentReactivePower: currentReactivePower.toFixed(2),
                targetReactivePower: targetReactivePower.toFixed(2),
                reactiveReduction: (currentReactivePower - targetReactivePower).toFixed(2),
                excessCurrentReactive: (excessCurrentReactive / 1000).toFixed(2), // MWh'e √ßevir
                excessTargetReactive: (excessTargetReactive / 1000).toFixed(2),
                penaltyAvoided: (penaltyAvoided / 1000).toFixed(2), // MWh
                reactivePenaltySavings: reactivePenaltySavings.toFixed(2),
                capacityIncrease: capacityIncrease.toFixed(2),
                powerFactorBonus: powerFactorBonus.toFixed(2),
                annualSavings: annualSavings.toFixed(2),
                monthlySavings: monthlySavings.toFixed(2),
                allowedReactiveRatio: (allowedReactiveRatio * 100).toFixed(0)
            };
        }

        // Geri √∂deme s√ºresi hesaplama
        function calculatePaybackPeriod(cost, savings) {
            const paybackMonths = (cost.totalCost / parseFloat(savings.monthlySavings)).toFixed(1);
            const paybackYears = (paybackMonths / 12).toFixed(1);

            return {
                months: paybackMonths,
                years: paybackYears
            };
        }

        function determineStageCount(totalPower, motors, devices) {
            // Motor √ßalƒ±≈üma rejimlerine g√∂re kademe sayƒ±sƒ± belirleme
            const hasIntermittent = motors.some(m => m.regime === 'intermittent');
            const hasHeavyLoad = motors.some(m => m.regime === 'heavy');
            const hasInverters = devices.some(d => d.deviceType === 'inverter');

            if (totalPower < 50) return 4;
            if (totalPower < 150) return hasIntermittent || hasInverters ? 6 : 5;
            if (totalPower < 300) return hasIntermittent || hasInverters ? 8 : 6;
            if (totalPower < 500) return hasHeavyLoad || hasInverters ? 10 : 8;
            return hasHeavyLoad || hasInverters ? 12 : 10;
        }

        function calculateStages(totalCapacitivePower, stageCount, motors, devices, avgTHD, systemVoltage) {
            const stages = [];
            const hasVariableLoad = motors.some(m => m.regime !== 'continuous') ||
                                   devices.some(d => d.deviceType === 'inverter');

            // Reakt√∂r gereksinimi
            const reactorPercentage = avgTHD > 40 ? 14 : avgTHD > 25 ? 7 : 0;
            const needsReactor = reactorPercentage > 0;

            if (hasVariableLoad) {
                // Deƒüi≈üken y√ºk i√ßin √ºstel kademe dizilimi (1:1:2:2:4 mantƒ±ƒüƒ±)
                const baseStage = totalCapacitivePower / (Math.pow(2, Math.ceil(stageCount / 2)));
                let currentMultiplier = 1;
                let totalAssigned = 0;

                for (let i = 0; i < stageCount; i++) {
                    const stagePower = baseStage * currentMultiplier;
                    const stageType = i < 2 ? 'K√º√ß√ºk Y√ºk D√ºzenleme' : i < 4 ? 'Orta Y√ºk' : 'Aƒüƒ±r Y√ºk';
                    const switchType = i < 3 ? 'Statik (Trist√∂r/Thyristor)' : 'Kontakt√∂r (AC3)';

                    // Kondansat√∂r tipi belirleme
                    let capacitorSpec = '';
                    if (needsReactor) {
                        capacitorSpec = avgTHD > 40 ?
                            `Anti-Harmonik Kondansat√∂r + %${reactorPercentage} Seri Reakt√∂r` :
                            `Anti-Harmonik Kondansat√∂r + %${reactorPercentage} Seri Reakt√∂r`;
                    } else {
                        capacitorSpec = avgTHD > 15 ?
                            'Harmonik Filtreli Kondansat√∂r (HD Type)' :
                            'Standart G√º√ß Kondansat√∂r√º';
                    }

                    const current = (stagePower * 1000) / (Math.sqrt(3) * systemVoltage);
                    const cableCrossSection = calculateCableCrossSection(current);
                    const mcbRating = calculateMCBRating(current);

                    stages.push({
                        stage: i + 1,
                        power: stagePower,
                        type: stageType,
                        switchType: switchType,
                        capacitorSpec: capacitorSpec,
                        reactorRequired: needsReactor,
                        reactorPercentage: needsReactor ? reactorPercentage : 0,
                        reactorPower: needsReactor ? (stagePower * reactorPercentage / 100) : 0,
                        voltage: systemVoltage,
                        current: current,
                        cableCrossSection: cableCrossSection,
                        mcbRating: mcbRating,
                        contactorRating: Math.ceil(current * 1.5 / 5) * 5, // 1.5x akƒ±m, 5'in katlarƒ±
                        standard: 'IEC 60831-1/2, EN 60439-1'
                    });
                    totalAssigned += stagePower;

                    if ((i + 1) % 2 === 0) currentMultiplier *= 2;
                }

                // Kalan g√ºc√º son kademeye ekle
                if (totalAssigned < totalCapacitivePower) {
                    const lastStage = stages[stages.length - 1];
                    lastStage.power += (totalCapacitivePower - totalAssigned);
                    lastStage.reactorPower = needsReactor ? (lastStage.power * reactorPercentage / 100) : 0;
                    lastStage.current = (lastStage.power * 1000) / (Math.sqrt(3) * systemVoltage);
                    lastStage.cableCrossSection = calculateCableCrossSection(lastStage.current);
                    lastStage.mcbRating = calculateMCBRating(lastStage.current);
                    lastStage.contactorRating = Math.ceil(lastStage.current * 1.5 / 5) * 5;
                }
            } else {
                // Sabit y√ºk i√ßin e≈üit kademe dizilimi
                const stagePower = totalCapacitivePower / stageCount;
                for (let i = 0; i < stageCount; i++) {
                    let capacitorSpec = '';
                    if (needsReactor) {
                        capacitorSpec = avgTHD > 40 ?
                            `Anti-Harmonik Kondansat√∂r + %${reactorPercentage} Seri Reakt√∂r` :
                            `Anti-Harmonik Kondansat√∂r + %${reactorPercentage} Seri Reakt√∂r`;
                    } else {
                        capacitorSpec = avgTHD > 15 ?
                            'Harmonik Filtreli Kondansat√∂r (HD Type)' :
                            'Standart G√º√ß Kondansat√∂r√º';
                    }

                    const current = (stagePower * 1000) / (Math.sqrt(3) * systemVoltage);
                    const cableCrossSection = calculateCableCrossSection(current);
                    const mcbRating = calculateMCBRating(current);

                    stages.push({
                        stage: i + 1,
                        power: stagePower,
                        type: 'Standart',
                        switchType: 'Kontakt√∂r (AC3)',
                        capacitorSpec: capacitorSpec,
                        reactorRequired: needsReactor,
                        reactorPercentage: needsReactor ? reactorPercentage : 0,
                        reactorPower: needsReactor ? (stagePower * reactorPercentage / 100) : 0,
                        voltage: systemVoltage,
                        current: current,
                        cableCrossSection: cableCrossSection,
                        mcbRating: mcbRating,
                        contactorRating: Math.ceil(current * 1.5 / 5) * 5,
                        standard: 'IEC 60831-1/2, EN 60439-1'
                    });
                }
            }

            return stages;
        }

        // Kablo kesiti hesaplama (Bakƒ±r kablo i√ßin)
        function calculateCableCrossSection(current) {
            const safetyFactor = 1.3; // Kondansat√∂rler i√ßin g√ºvenlik fakt√∂r√º
            const adjustedCurrent = current * safetyFactor;

            if (adjustedCurrent <= 16) return 2.5;
            if (adjustedCurrent <= 21) return 4;
            if (adjustedCurrent <= 28) return 6;
            if (adjustedCurrent <= 36) return 10;
            if (adjustedCurrent <= 49) return 16;
            if (adjustedCurrent <= 63) return 25;
            if (adjustedCurrent <= 81) return 35;
            if (adjustedCurrent <= 104) return 50;
            if (adjustedCurrent <= 125) return 70;
            if (adjustedCurrent <= 151) return 95;
            if (adjustedCurrent <= 175) return 120;
            if (adjustedCurrent <= 207) return 150;
            if (adjustedCurrent <= 239) return 185;
            if (adjustedCurrent <= 273) return 240;
            return 300;
        }

        // MCB/Sigorta deƒüeri hesaplama
        function calculateMCBRating(current) {
            const mcbFactor = 1.5; // Kondansat√∂rler i√ßin 1.5x akƒ±m
            const requiredRating = current * mcbFactor;

            const standardRatings = [6, 10, 13, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125, 160, 200, 250];
            for (let rating of standardRatings) {
                if (rating >= requiredRating) return rating;
            }
            return 250;
        }

        // Aktif g√º√ß bazlƒ± √∂zel sonu√ß ekranƒ±
        function displayPowerBasedResults(results) {
            const resultsDiv = document.getElementById('results');

            let cosPhiInfoText = '';
            if (results.cosPhiMode === 'known') {
                cosPhiInfoText = `<strong>${results.currentPF.toFixed(3)}</strong> (Sahadan √∂l√ß√ºlen deƒüer) ‚úÖ`;
            } else if (results.usedReactivePowerDirect) {
                cosPhiInfoText = `<strong>${results.currentPF.toFixed(3)}</strong> (Reaktif g√º√ß: ${results.currentReactivePower.toFixed(2)} kVAr'dan hesaplanan) ‚úÖ`;
            } else {
                cosPhiInfoText = `<strong>${results.currentPF.toFixed(3)}</strong> (Tahmini deƒüer) ‚ö†Ô∏è`;
            }

            resultsDiv.innerHTML = `
                <div class="results fade-in">
                    <h2>‚ö° Hƒ±zlƒ± Kompanzasyon Hesaplama Sonu√ßlarƒ±</h2>

                    <div class="action-buttons" style="margin-bottom: 20px;">
                        <button class="print-button" onclick="window.print()">üñ®Ô∏è Yazdƒ±r / PDF</button>
                        <button onclick="saveToLocalStorage()">üíæ Kaydet</button>
                    </div>

                    <div class="info" style="background: #e3f2fd; border-color: #2196f3;">
                        <strong>üìä Gƒ∞Rƒ∞LEN Bƒ∞LGƒ∞LER</strong><br>
                        ‚Ä¢ Toplam Aktif G√º√ß: <strong>${results.totalActivePower.toFixed(2)} kW</strong><br>
                        ‚Ä¢ Mevcut Cos œÜ: ${cosPhiInfoText}<br>
                        ‚Ä¢ Hedef Cos œÜ: <strong>${results.targetPF}</strong><br>
                        ‚Ä¢ Harmonik Seviyesi: <strong>THD ~${results.avgTHD}%</strong><br>
                        ‚Ä¢ Elektrik Fiyatƒ±: <strong>${parseFloat(document.getElementById('electricityPrice').value).toFixed(2)} TL/kWh</strong><br>
                        ‚Ä¢ Yƒ±llƒ±k √áalƒ±≈üma: <strong>${parseFloat(document.getElementById('operatingHours').value).toFixed(0)} saat</strong>
                    </div>

                    <!-- Gerekli Kondansat√∂r G√ºc√º -->
                    <div class="result-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h3 style="color: white; border-color: white;">üéØ GEREKLƒ∞ KONDANSAT√ñR G√úC√ú</h3>
                        <div style="background: white; padding: clamp(1rem, 3vw, 1.5rem); border-radius: 8px; color: #333; margin-top: 15px;">
                            <div style="text-align: center; margin-bottom: clamp(1rem, 3vw, 1.5rem);">
                                <div style="font-size: clamp(2rem, 6vw, 3rem); font-weight: bold; color: #667eea; word-wrap: break-word;">
                                    ${results.adjustedCapacitivePower.toFixed(2)} kVAr
                                </div>
                                <div style="font-size: clamp(1rem, 2.5vw, 1.2rem); color: #666; margin-top: 10px; word-wrap: break-word;">
                                    ${results.capacitorType}
                                </div>
                            </div>

                            ${results.reactorRequired ? `
                            <div style="background: #fff3cd; padding: clamp(0.875rem, 2.5vw, 1.25rem); border-radius: 8px; border: 2px solid #ffc107; margin-top: 15px; word-wrap: break-word;">
                                <strong style="color: #856404; font-size: clamp(0.95rem, 2vw, 1.05rem);">‚ö†Ô∏è Dƒ∞KKAT: Reakt√∂r Gerekli!</strong><br>
                                <div style="margin-top: 10px; font-size: clamp(0.9rem, 2vw, 1.1rem);">
                                    ‚Ä¢ Reakt√∂r Tipi: <strong>%${results.reactorPercentage} Seri Reakt√∂r</strong><br>
                                    ‚Ä¢ Reakt√∂r G√ºc√º: <strong>${results.reactorPower.toFixed(2)} kVAr</strong><br>
                                    ‚Ä¢ Sebep: Y√ºksek harmonik y√ºk√º (THD: ${results.avgTHD}%)
                                </div>
                            </div>
                            ` : `
                            <div style="background: #e8f5e9; padding: clamp(0.875rem, 2.5vw, 1.25rem); border-radius: 8px; border: 2px solid #4caf50; margin-top: 15px; word-wrap: break-word; font-size: clamp(0.9rem, 1.8vw, 0.95rem);">
                                <strong style="color: #2e7d32;">‚úì Standart Kondansat√∂r Yeterlidir</strong><br>
                                Harmonik seviyesi d√º≈ü√ºk olduƒüu i√ßin reakt√∂re gerek yoktur.
                            </div>
                            `}
                        </div>
                    </div>

                    <!-- Maliyet Analizi -->
                    <div class="result-card">
                        <h3>üí∞ TAHMƒ∞Nƒ∞ YATIRIM MALƒ∞YETƒ∞</h3>
                        <div class="result-item">
                            <span class="result-label">Kondansat√∂r Maliyeti:</span>
                            <span class="result-value">${results.estimatedCost.capacitorCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫</span>
                        </div>
                        ${results.reactorRequired ? `
                        <div class="result-item">
                            <span class="result-label">Reakt√∂r Maliyeti:</span>
                            <span class="result-value">${results.estimatedCost.reactorCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫</span>
                        </div>
                        ` : ''}
                        <div class="result-item">
                            <span class="result-label">Panel, Kontrol ve Montaj:</span>
                            <span class="result-value">${results.estimatedCost.panelAndInstallation.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫</span>
                        </div>
                        <div class="result-item" style="background: #f0f0f0; padding: clamp(0.875rem, 2.5vw, 1.25rem); border-radius: 8px; margin-top: 10px;">
                            <span class="result-label" style="font-size: clamp(1rem, 2.5vw, 1.2rem);"><strong>TOPLAM MALƒ∞YET:</strong></span>
                            <span class="result-value" style="font-size: clamp(1.2rem, 3vw, 1.5rem); color: #667eea;"><strong>${results.estimatedCost.totalCost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫</strong></span>
                        </div>
                        <div style="margin-top: 15px; padding: clamp(0.75rem, 2vw, 1rem); background: #fff9e6; border-radius: 5px; font-size: clamp(0.85rem, 1.8vw, 0.9rem); color: #856404; word-wrap: break-word;">
                            <strong>üìù Not:</strong> Maliyet tahmini ortalama piyasa fiyatlarƒ±na g√∂re yapƒ±lmƒ±≈ütƒ±r.
                            Ger√ßek maliyet tedarik√ßiye, markaya ve proje √∂zelliklerine g√∂re deƒüi≈üebilir.
                        </div>
                    </div>

                    <!-- Enerji Tasarrufu -->
                    <div class="result-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                        <h3 style="color: white; border-color: white;">üí° ENERJƒ∞ TASARRUFU ve GERƒ∞ √ñDEME</h3>
                        <div style="background: white; padding: clamp(1rem, 3vw, 1.5rem); border-radius: 8px; color: #333; margin-top: 15px;">
                            <div style="text-align: center; margin-bottom: clamp(1rem, 3vw, 1.5rem);">
                                <div style="font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: bold; color: #11998e; word-wrap: break-word;">
                                    ${results.energySavings.annualSavings.replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫/Yƒ±l
                                </div>
                                <div style="font-size: clamp(0.95rem, 2.2vw, 1.1rem); color: #666; margin-top: 5px; word-wrap: break-word;">
                                    (Aylƒ±k: ${results.energySavings.monthlySavings.replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫)
                                </div>
                            </div>

                            <div style="background: #e3f2fd; padding: clamp(0.75rem, 2vw, 1rem); border-radius: 8px; margin-bottom: clamp(0.875rem, 2.5vw, 1.25rem); border-left: 4px solid #2196f3;">
                                <strong style="color: #1976d2; font-size: clamp(0.9rem, 1.8vw, 0.95rem);">üìã Hesaplama Parametreleri:</strong>
                                <div style="margin-top: 8px; font-size: clamp(0.85rem, 1.8vw, 0.9rem); color: #666;">
                                    ‚Ä¢ Elektrik Birim Fiyatƒ±: <strong>${parseFloat(document.getElementById('electricityPrice').value).toFixed(2)} TL/kWh</strong><br>
                                    ‚Ä¢ Yƒ±llƒ±k √áalƒ±≈üma Saati: <strong>${parseFloat(document.getElementById('operatingHours').value).toFixed(0)} saat</strong><br>
                                    ‚Ä¢ Yƒ±llƒ±k Aktif Enerji: <strong>${(results.totalActivePower * parseFloat(document.getElementById('operatingHours').value) / 1000).toFixed(0)} MWh</strong>
                                </div>
                            </div>

                            <h4 style="color: #667eea; margin: clamp(0.875rem, 2.5vw, 1.25rem) 0; font-size: clamp(1rem, 2.2vw, 1.1rem);">üìä Tasarruf Detaylarƒ±:</h4>

                            <div style="background: #f8f9fa; padding: clamp(0.875rem, 2.5vw, 1.25rem); border-radius: 8px; margin: clamp(0.625rem, 2vw, 0.875rem) 0; word-wrap: break-word;">
                                <strong style="color: #667eea; font-size: clamp(0.9rem, 1.8vw, 0.95rem);">1Ô∏è‚É£ Hat ve Transformat√∂r Kayƒ±p Tasarrufu:</strong>
                                <div class="result-item" style="margin-top: 10px;">
                                    <span class="result-label">G√º√ß Kaybƒ± Azalmasƒ±:</span>
                                    <span class="result-value">${results.energySavings.lossReduction} kW</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">Yƒ±llƒ±k Tasarruf:</span>
                                    <span class="result-value">${results.energySavings.activeLossSavings.replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫</span>
                                </div>
                            </div>

                            <div style="background: #fff3e0; padding: clamp(0.875rem, 2.5vw, 1.25rem); border-radius: 8px; margin: clamp(0.625rem, 2vw, 0.875rem) 0; word-wrap: break-word;">
                                <strong style="color: #f57c00; font-size: clamp(0.9rem, 1.8vw, 0.95rem);">2Ô∏è‚É£ Reaktif Enerji Ceza Tasarrufu (TEDA≈û):</strong>
                                <div style="margin-top: 10px; font-size: clamp(0.85rem, 1.8vw, 0.95rem); color: #666;">
                                    ‚ÑπÔ∏è TEDA≈û Kuralƒ±: Reaktif t√ºketim, aktif t√ºketimin <strong>%${results.energySavings.allowedReactiveRatio}'sine</strong> kadar √ºcretsiz
                                </div>
                                <div class="result-item" style="margin-top: 10px;">
                                    <span class="result-label">Mevcut Fazla Reaktif:</span>
                                    <span class="result-value" style="color: #f44336;">${results.energySavings.excessCurrentReactive} MWh/Yƒ±l (Cezalƒ±)</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">Hedef Fazla Reaktif:</span>
                                    <span class="result-value" style="color: #4caf50;">${results.energySavings.excessTargetReactive} MWh/Yƒ±l</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">Cezadan Ka√ßƒ±nƒ±lan:</span>
                                    <span class="result-value" style="color: #667eea;">${results.energySavings.penaltyAvoided} MWh/Yƒ±l</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">Yƒ±llƒ±k Tasarruf:</span>
                                    <span class="result-value">${results.energySavings.reactivePenaltySavings.replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫</span>
                                </div>
                            </div>

                            ${parseFloat(results.energySavings.powerFactorBonus) > 0 ? `
                            <div style="background: #e8f5e9; padding: clamp(0.875rem, 2.5vw, 1.25rem); border-radius: 8px; margin: clamp(0.625rem, 2vw, 0.875rem) 0; word-wrap: break-word;">
                                <strong style="color: #2e7d32; font-size: clamp(0.9rem, 1.8vw, 0.95rem);">3Ô∏è‚É£ G√º√ß √áarpanƒ± Primi (Bonus):</strong>
                                <div style="margin-top: 10px; font-size: clamp(0.85rem, 1.8vw, 0.95rem); color: #666;">
                                    ‚úÖ Cos œÜ > 0.95 olduƒüunda bazƒ± daƒüƒ±tƒ±m ≈üirketleri fatura indirimi yapƒ±yor
                                </div>
                                <div class="result-item" style="margin-top: 10px;">
                                    <span class="result-label">Tahmini ƒ∞ndirim:</span>
                                    <span class="result-value">${results.energySavings.powerFactorBonus.replace(/\B(?=(\d{3})+(?!\d))/g, ".")} ‚Ç∫/Yƒ±l</span>
                                </div>
                            </div>
                            ` : ''}

                            <div style="background: #e3f2fd; padding: clamp(0.875rem, 2.5vw, 1.25rem); border-radius: 8px; margin: clamp(0.625rem, 2vw, 0.875rem) 0; word-wrap: break-word;">
                                <strong style="color: #1976d2; font-size: clamp(0.9rem, 1.8vw, 0.95rem);">üíº Ek Fayda - Kapasite Artƒ±≈üƒ±:</strong>
                                <div style="margin-top: 10px; font-size: clamp(0.85rem, 1.8vw, 0.95rem);">
                                    Aynƒ± transformat√∂r ve kablolarla <strong>${results.energySavings.capacityIncrease} kW</strong> daha fazla y√ºk ta≈üƒ±nabilir!
                                </div>
                            </div>

                            <div style="background: #e8f5e9; padding: clamp(1rem, 3vw, 1.5rem); border-radius: 8px; margin-top: clamp(1rem, 3vw, 1.5rem); border: 3px solid #4caf50;">
                                <h4 style="color: #2e7d32; margin-bottom: 10px; text-align: center; font-size: clamp(1rem, 2.5vw, 1.15rem);">üéØ GERƒ∞ √ñDEME S√úRESƒ∞ (ROI)</h4>
                                <div style="text-align: center; font-size: clamp(1.5rem, 4vw, 2rem); font-weight: bold; color: #2e7d32;">
                                    ${results.paybackPeriod.years} Yƒ±l
                                </div>
                                <div style="text-align: center; font-size: clamp(1rem, 2.5vw, 1.2rem); color: #666; margin-top: 5px;">
                                    (${results.paybackPeriod.months} Ay)
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reaktif G√º√ß Analizi -->
                    <div class="result-card">
                        <h3>‚ö° Reaktif G√º√ß Analizi</h3>
                        <div class="result-item">
                            <span class="result-label">Mevcut Reaktif G√º√ß:</span>
                            <span class="result-value">${results.currentReactivePower.toFixed(2)} kVAr</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Hedef Reaktif G√º√ß:</span>
                            <span class="result-value">${results.targetReactivePower.toFixed(2)} kVAr</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Kompanse Edilecek:</span>
                            <span class="result-value" style="color: #f5576c;">${results.requiredCapacitivePower.toFixed(2)} kVAr</span>
                        </div>
                        ${results.adjustedCapacitivePower > results.requiredCapacitivePower ? `
                        <div class="result-item">
                            <span class="result-label">Harmonik D√ºzeltmeli:</span>
                            <span class="result-value" style="color: #667eea;">${results.adjustedCapacitivePower.toFixed(2)} kVAr</span>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Sistem Voltajƒ± -->
                    <div class="result-card">
                        <h3>üîå Sistem Bilgisi</h3>
                        <div class="result-item">
                            <span class="result-label">Sistem Voltajƒ±:</span>
                            <span class="result-value">${results.systemVoltage} V, 3 Faz</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Sistem Frekansƒ±:</span>
                            <span class="result-value">${results.systemFrequency} Hz</span>
                        </div>
                    </div>

                    <!-- Tasarruf Hesaplama Metodolojisi -->
                    <div class="info" style="background: #f3e5f5; border-color: #9c27b0;">
                        <strong>üìê TASARRUF HESAPLAMA METODOLOJƒ∞Sƒ∞</strong>
                        <ul style="margin-top: 10px; margin-left: 20px; font-size: 0.95em;">
                            <li><strong>Hat Kayƒ±plarƒ±:</strong> G√∂r√ºn√ºr g√ºc√ºn %2.5'i (transformat√∂r + kablo kayƒ±plarƒ±)</li>
                            <li><strong>TEDA≈û Reaktif Ceza:</strong> Aktif enerjinin %20'sini a≈üan reaktif t√ºketim cezalandƒ±rƒ±lƒ±r</li>
                            <li><strong>Ceza Oranƒ±:</strong> Aktif enerji fiyatƒ±nƒ±n ~%60'ƒ± (2.10 ‚Ç∫/kVArh)</li>
                            <li><strong>Elektrik Fiyatƒ±:</strong> 3.50 ‚Ç∫/kWh (Sanayi tarifesi ortalamasƒ±)</li>
                            <li><strong>√áalƒ±≈üma Saati:</strong> 6000 saat/yƒ±l (250 g√ºn x 24 saat)</li>
                            <li><strong>G√º√ß Fakt√∂r√º Primi:</strong> Cos œÜ > 0.95 ise bazƒ± b√∂lgelerde %2-5 indirim</li>
                        </ul>
                    </div>

                    <!-- √ñneriler -->
                    <div class="info">
                        <strong>üí° √ñNERƒ∞LER ve SONRAKI ADIMLAR</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Bu hesaplama <strong>hƒ±zlƒ± √∂n deƒüerlendirme</strong> i√ßindir</li>
                            <li>Kesin tasarƒ±m i√ßin detaylƒ± elektrik projesi hazƒ±rlanmalƒ±dƒ±r</li>
                            <li>Kompanzasyon panosu se√ßiminde ${results.adjustedCapacitivePower.toFixed(0)} kVAr civarƒ± aranmalƒ±dƒ±r</li>
                            ${results.reactorRequired ? '<li><strong>Mutlaka reakt√∂rl√º tip</strong> se√ßilmelidir (Harmonik koruma)</li>' : ''}
                            <li>Enerji analiz√∂r√º ile 1 haftalƒ±k √∂l√ß√ºm yapƒ±lmasƒ± √∂nerilir</li>
                            <li>Tedarik√ßilerden <strong>3 farklƒ± teklif</strong> alƒ±nmalƒ±dƒ±r</li>
                            <li>Geri √∂deme s√ºresi <strong>${results.paybackPeriod.years} yƒ±l</strong> - Yatƒ±rƒ±m ekonomiktir!</li>
                            <li><strong>TEDA≈û reaktif ceza detaylarƒ±:</strong> Faturanƒ±zdan kontrol edebilirsiniz</li>
                        </ul>
                    </div>

                    ${!results.cosPhiMode || results.cosPhiMode === 'unknown' ? `
                    <div class="warning">
                        <strong>‚ö†Ô∏è UYARI:</strong> Bu hesaplama tahmini deƒüer kullanƒ±larak yapƒ±lmƒ±≈ütƒ±r.
                        Daha doƒüru sonu√ß i√ßin:
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Enerji analiz√∂r√º ile ger√ßek Cos œÜ √∂l√ß√ºm√º yapƒ±n</li>
                            <li>Veya saya√ßtan reaktif g√º√ß deƒüerini okuyun</li>
                            <li>7 g√ºn s√ºrekli √∂l√ß√ºm yapƒ±lmasƒ± idealdir</li>
                        </ul>
                    </div>
                    ` : ''}
                </div>
            `;

            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            showNotification('Hesaplama tamamlandƒ±!', 'success');
        }

        function displayResults(results) {
            setTimeout(() => {
                hideLoading();
                showNotification('Hesaplama ba≈üarƒ±yla tamamlandƒ±!', 'success');
            }, 200);

            const resultsDiv = document.getElementById('results');

            let harmonicWarning = '';
            if (results.avgTHD > 40) {
                harmonicWarning = `
                    <div class="warning">
                        <strong>‚ö†Ô∏è KRƒ∞Tƒ∞K:</strong> √áok y√ºksek harmonik seviyesi tespit edildi (THD: ${results.avgTHD.toFixed(1)}%).
                        14% Reakt√∂rl√º anti-harmonik kondansat√∂r ve harmonik filtre kullanƒ±mƒ± zorunludur!
                    </div>
                `;
            } else if (results.avgTHD > 25) {
                harmonicWarning = `
                    <div class="warning">
                        <strong>‚ö†Ô∏è UYARI:</strong> Y√ºksek harmonik seviyesi tespit edildi (THD: ${results.avgTHD.toFixed(1)}%).
                        7% Reakt√∂rl√º anti-harmonik kondansat√∂r kullanƒ±mƒ± zorunludur!
                    </div>
                `;
            } else if (results.avgTHD > 15) {
                harmonicWarning = `
                    <div class="info">
                        <strong>‚ÑπÔ∏è Bƒ∞LGƒ∞:</strong> Orta seviye harmonik tespit edildi (THD: ${results.avgTHD.toFixed(1)}%).
                        Harmonik √∂nleyici kondansat√∂r √∂nerilir.
                    </div>
                `;
            }

            // Motor-Cihaz baƒülantƒ± bilgisi
            let connectionInfo = '';
            if (results.connectedMotors > 0) {
                connectionInfo = `
                    <div class="info">
                        <strong>üîó BAƒûLANTI Bƒ∞LGƒ∞Sƒ∞:</strong> ${results.connectedMotors} motor cihaz ile baƒülantƒ±lƒ±.
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            ${results.motorConnections.map(conn =>
                                `<li><strong>${conn.motor.name}</strong> ‚Üí ${conn.device.name}
                                (${conn.device.deviceType === 'inverter' ?
                                    `Frekans: ${conn.device.frequency}%, G√º√ß Azaltma: ${(conn.powerReduction * 100).toFixed(0)}%` :
                                    'Yumu≈üak Kalkƒ±≈ü'})</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }

            const stagesHTML = results.stages.map(stage => `
                <div class="stage-card">
                    <h4>üî∑ Kademe ${stage.stage} - Sipari≈ü Detayƒ±</h4>
                    <div class="result-item">
                        <span class="result-label">Kondansat√∂r G√ºc√º:</span>
                        <span class="result-value">${stage.power.toFixed(2)} kVAr</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Kondansat√∂r Tipi:</span>
                        <span class="result-value">${stage.capacitorSpec}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Gerilim Seviyesi:</span>
                        <span class="result-value">${stage.voltage} V (3 Faz)</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Kademe Akƒ±mƒ±:</span>
                        <span class="result-value">${stage.current.toFixed(2)} A</span>
                    </div>
                    ${stage.reactorRequired ? `
                    <div class="result-item" style="background: #fff3cd; padding: 8px; border-radius: 5px; margin: 5px 0;">
                        <span class="result-label">‚ö†Ô∏è Reakt√∂r Zorunlu:</span>
                        <span class="result-value">%${stage.reactorPercentage} Seri Reakt√∂r (${stage.reactorPower.toFixed(2)} kVAr)</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Reakt√∂r Baƒülantƒ±:</span>
                        <span class="result-value">Kondansat√∂r ile Seri Baƒülantƒ±</span>
                    </div>
                    ` : ''}
                    <div class="result-item">
                        <span class="result-label">Kademe Tipi:</span>
                        <span class="result-value">${stage.type}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Anahtarlama Cihazƒ±:</span>
                        <span class="result-value">${stage.switchType}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Kontakt√∂r Deƒüeri:</span>
                        <span class="result-value">${stage.contactorRating}A (AC3 tipi, yardƒ±mcƒ± kontaklƒ±)</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Sigorta/MCB Deƒüeri:</span>
                        <span class="result-value">${stage.mcbRating}A (C Tipi veya gG Tipi)</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Kablo Kesiti (Bakƒ±r):</span>
                        <span class="result-value">${stage.cableCrossSection} mm¬≤ (NYY veya NYM)</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Uygun Standart:</span>
                        <span class="result-value" style="font-size: 0.85em;">${stage.standard}</span>
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #e8f5e9; border-radius: 5px; font-size: 0.9em;">
                        <strong>üìã Kademe ${stage.stage} Sipari≈ü Detayƒ±:</strong><br>
                        ‚Ä¢ Kondansat√∂r: ${stage.power.toFixed(2)} kVAr, ${stage.voltage}V, 3F, ${stage.capacitorSpec}<br>
                        ${stage.reactorRequired ? `‚Ä¢ Seri Reakt√∂r: ${stage.reactorPercentage}% (${stage.reactorPower.toFixed(2)} kVAr), Demir √áekirdekli<br>` : ''}
                        ‚Ä¢ Kontakt√∂r: ${stage.contactorRating}A, AC3, ${stage.voltage}V Bobin, NO+NC Yardƒ±mcƒ± Kontak<br>
                        ‚Ä¢ Koruma: MCB/Sigorta ${stage.mcbRating}A, ≈ûalter ${stage.mcbRating}A<br>
                        ‚Ä¢ Kablo: ${stage.cableCrossSection}mm¬≤ x 4 (3F+N veya 3F+PE), NYY/NYM<br>
                        ‚Ä¢ De≈üarj Direnci: Dahili veya Harici (Kondansat√∂r ile uyumlu)<br>
                        ‚Ä¢ G√∂sterge: Kontakt√∂r √ßalƒ±≈üma durumu i√ßin LED/Lamba
                    </div>
                </div>
            `).join('');

            // Sonu√ßlarƒ± sakla
            lastResults = results;

            // Tasarƒ±m modu bilgisi
            let designModeInfo = '';
            if (results.designMode === 'new') {
                designModeInfo = `
                    <div class="info" style="background: #e3f2fd; border-color: #2196f3;">
                        <strong>üÜï TASARIM MODU: Sƒ±fƒ±rdan Yeni Sistem</strong><br>
                        Bu hesaplama, motorlar ve cihazlarƒ±n kendi cos œÜ deƒüerlerinden yola √ßƒ±karak yapƒ±lmƒ±≈ütƒ±r.
                        Mevcut sistem cos œÜ deƒüeri dikkate alƒ±nmamƒ±≈ütƒ±r. Tamamƒ± yeni kurulum i√ßin ge√ßerlidir.
                    </div>
                `;
            } else if (results.designMode === 'upgrade') {
                designModeInfo = `
                    <div class="info" style="background: #fff3e0; border-color: #ff9800;">
                        <strong>üîÑ TASARIM MODU: Mevcut Sistemi Geli≈ütirme</strong><br>
                        Bu hesaplama, mevcut sistemin cos œÜ deƒüerinden (${results.currentPF}) hedefe (${results.targetPF}) ula≈ümak i√ßin
                        <strong>sadece ilave edilmesi gereken kondansat√∂r g√ºc√ºn√º</strong> g√∂stermektedir.
                    </div>
                `;
            } else if (results.designMode === 'powerBased') {
                let cosPhiInfoText = '';
                if (results.cosPhiMode === 'known') {
                    cosPhiInfoText = `Mevcut Cos œÜ: <strong>${results.currentPF.toFixed(3)}</strong> (Sahadan √∂l√ß√ºlen deƒüer)`;
                } else if (results.usedReactivePowerDirect) {
                    cosPhiInfoText = `Mevcut Cos œÜ: <strong>${results.currentPF.toFixed(3)}</strong> (Reaktif g√º√ß: ${results.currentReactivePower.toFixed(2)} kVAr'dan hesaplanan)`;
                } else {
                    cosPhiInfoText = `Mevcut Cos œÜ: <strong>${results.currentPF.toFixed(3)}</strong> (Tahmini deƒüer)`;
                }

                designModeInfo = `
                    <div class="info" style="background: #f3e5f5; border-color: #9c27b0;">
                        <strong>‚ö° TASARIM MODU: Aktif G√º√ß Bazlƒ± Hƒ±zlƒ± Hesaplama (Saha Modu)</strong><br>
                        üìä Toplam Aktif G√º√ß: <strong>${results.totalActivePower.toFixed(2)} kW</strong><br>
                        üìà ${cosPhiInfoText}<br>
                        üéØ Hedef Cos œÜ: <strong>${results.targetPF}</strong><br>
                        ${results.cosPhiMode === 'unknown' ? '<span style="color: #ff6f00;">‚ö†Ô∏è Not: Tahmini deƒüer kullanƒ±ldƒ±. Daha doƒüru hesaplama i√ßin mevcut Cos œÜ veya reaktif g√º√ß √∂l√ß√ºm√º √∂nerilir.</span>' : '<span style="color: #4caf50;">‚úì √ñl√ß√ºlen deƒüer kullanƒ±ldƒ± - Doƒüru hesaplama</span>'}
                    </div>
                `;
            }

            resultsDiv.innerHTML = `
                <div class="results fade-in">
                    <h2>üìà Kompanzasyon Hesaplama Sonu√ßlarƒ±</h2>

                    <div class="action-buttons" style="margin-bottom: 20px;">
                        <button class="print-button" onclick="generatePDF()">üñ®Ô∏è PDF Rapor / Yazdƒ±r</button>
                        <button onclick="saveToLocalStorage()">üíæ Sonu√ßlarƒ± Kaydet</button>
                    </div>

                    ${designModeInfo}
                    ${harmonicWarning}
                    ${connectionInfo}

                    <!-- Grafikler -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div class="chart-container">
                            <canvas id="powerChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="harmonicChart"></canvas>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>üîå Sistem √ñzeti</h3>
                        <div class="result-item">
                            <span class="result-label">Toplam Aktif G√º√ß:</span>
                            <span class="result-value">${results.totalActivePower.toFixed(2)} kW</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Motor Sayƒ±sƒ±:</span>
                            <span class="result-value">${results.motorCount} adet</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ƒ∞nvert√∂r/Soft Starter:</span>
                            <span class="result-value">${results.deviceCount} adet</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Baƒülantƒ±lƒ± Motor-Cihaz:</span>
                            <span class="result-value">${results.connectedMotors} baƒülantƒ±</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Harmonik √úreten G√º√ß:</span>
                            <span class="result-value">${results.totalHarmonicPower.toFixed(2)} kW</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Sistem Voltajƒ±:</span>
                            <span class="result-value">${results.systemVoltage} V</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>‚ö° Reaktif G√º√ß Analizi</h3>
                        ${results.currentPF !== null ? `
                        <div class="result-item">
                            <span class="result-label">Mevcut Cos œÜ:</span>
                            <span class="result-value">${results.currentPF}</span>
                        </div>
                        ` : ''}
                        <div class="result-item">
                            <span class="result-label">Hedef Cos œÜ:</span>
                            <span class="result-value">${results.targetPF}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Mevcut Reaktif G√º√ß:</span>
                            <span class="result-value">${results.currentReactivePower.toFixed(2)} kVAr</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Hedef Reaktif G√º√ß:</span>
                            <span class="result-value">${results.targetReactivePower.toFixed(2)} kVAr</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Gerekli Kapasitif G√º√ß:</span>
                            <span class="result-value">${results.requiredCapacitivePower.toFixed(2)} kVAr</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>üåä Harmonik Analizi</h3>
                        <div class="result-item">
                            <span class="result-label">Ortalama THD:</span>
                            <span class="result-value">${results.avgTHD.toFixed(2)}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Harmonik D√ºzeltme Fakt√∂r√º:</span>
                            <span class="result-value">√ó${(results.adjustedCapacitivePower / results.requiredCapacitivePower).toFixed(2)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">D√ºzeltilmi≈ü Kapasitif G√º√ß:</span>
                            <span class="result-value">${results.adjustedCapacitivePower.toFixed(2)} kVAr</span>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>üîß Ekipman ƒ∞htiyacƒ±</h3>
                        <div class="result-item">
                            <span class="result-label">Kondansat√∂r Tipi:</span>
                            <span class="result-value">${results.capacitorType}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Toplam Kondansat√∂r G√ºc√º:</span>
                            <span class="result-value">${results.adjustedCapacitivePower.toFixed(2)} kVAr</span>
                        </div>
                        ${results.reactorRequired ? `
                        <div class="result-item">
                            <span class="result-label">‚ö†Ô∏è Reakt√∂r Gerekli:</span>
                            <span class="result-value">EVET</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Reakt√∂r G√ºc√º (7%):</span>
                            <span class="result-value">${results.reactorPower.toFixed(2)} kVAr</span>
                        </div>
                        ` : '<div class="result-item"><span class="result-label">Reakt√∂r Gerekli:</span><span class="result-value">HAYIR</span></div>'}
                    </div>

                    <div class="result-card">
                        <h3>üìä Kademe Konfig√ºrasyonu</h3>
                        <div class="result-item">
                            <span class="result-label">Toplam Kademe Sayƒ±sƒ±:</span>
                            <span class="result-value">${results.stageCount} Kademe</span>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">Kademe Detaylarƒ±:</h4>
                            ${stagesHTML}
                        </div>
                    </div>

                    <div class="info">
                        <strong>üí° TEKNIK √ñNERƒ∞LER ve Sƒ∞PARƒ∞≈û GEREKSƒ∞Nƒ∞MLERƒ∞:</strong>
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Kompanzasyon panosunda ${results.stageCount} kademe kullanƒ±lmasƒ± √∂nerilir</li>
                            ${results.reactorRequired ? `<li><strong>‚ö†Ô∏è ZORUNLU:</strong> T√ºm kademelere ${results.reactorPercentage}% seri reakt√∂r takƒ±lmalƒ±dƒ±r (Harmonik koruma)</li>` : ''}
                            ${results.reactorRequired ? '<li><strong>Reakt√∂r √ñzellikleri:</strong> Demir √ßekirdekli, sƒ±caklƒ±k korumalƒ±, kondansat√∂r ile seri baƒülantƒ±</li>' : ''}
                            <li>Reaktif G√º√ß Kontrol R√∂lesi (RGKR/PFC) - 12 kademeye kadar geni≈ületilebilir</li>
                            <li>Kondansat√∂rler ${results.systemVoltage}V, 50Hz, 3 Faz, IP20/IP54 koruma sƒ±nƒ±fƒ±</li>
                            <li>Her kademe i√ßin: A≈üƒ±rƒ± akƒ±m koruma, salter/sigorta, g√∂sterge lambalarƒ±</li>
                            ${results.avgTHD > 15 ? '<li><strong>Harmonik Koruma:</strong> Her kademeye de≈üarj direnci ve a≈üƒ±rƒ± akƒ±m r√∂lesi gereklidir</li>' : ''}
                            <li>Pano Tipi: IP42/IP54, duvar tipi veya serbest tip</li>
                            <li>Kontakt√∂rler: AC3 kullanƒ±m kategorisi, yardƒ±mcƒ± kontaklƒ±</li>
                            <li>Baƒülantƒ± ≈üekli: √ú√ßgen (Delta) baƒülantƒ± √∂nerilir</li>
                        </ul>
                    </div>

                    <div class="result-card">
                        <h3>üîå Ana Besleme ve Pano Giri≈üi</h3>
                        <div class="result-item">
                            <span class="result-label">Toplam Panel Akƒ±mƒ±:</span>
                            <span class="result-value">${results.totalPanelCurrent.toFixed(2)} A</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Ana Besleme MCB/Sigorta:</span>
                            <span class="result-value">${results.mainMCBRating} A (4 Kutup, C veya D Tipi)</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Ana Bara/Kablo Kesiti:</span>
                            <span class="result-value">${results.mainBusbarCrossSection} mm¬≤ (Bakƒ±r, NYY veya Bara)</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Akƒ±m Trafosu (CT):</span>
                            <span class="result-value">${Math.ceil(results.totalPanelCurrent * 1.2 / 5) * 5}/5A (Sƒ±nƒ±f 1, RGKR i√ßin)</span>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 5px; font-size: 0.9em;">
                            <strong>‚ö†Ô∏è Dƒ∞KKAT:</strong> Ana besleme kablosu tesisatƒ±n ana panosundan √ßekilecek.
                            Akƒ±m trafosunun ${Math.ceil(results.totalPanelCurrent * 1.2 / 5) * 5}/5A deƒüerinde olmasƒ± ve
                            RGKR cihazƒ±nƒ±n CT deƒüeri ile uyumlu olmasƒ± gerekir.
                        </div>
                    </div>

                    <div class="result-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h3 style="color: white; border-color: white;">üõí TOPLAM Sƒ∞PARƒ∞≈û Lƒ∞STESƒ∞</h3>
                        <div style="background: white; padding: 15px; border-radius: 8px; color: #333; margin-top: 15px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">üì¶ PANO ve EKIPMANLAR</h4>
                            <div class="result-item">
                                <span class="result-label">1. Kompanzasyon Panosu:</span>
                                <span class="result-value">${results.adjustedCapacitivePower.toFixed(2)} kVAr, ${results.stageCount} Kademe, IP42/IP54</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">2. G√º√ß Kondansat√∂rleri:</span>
                                <span class="result-value">${results.stageCount} Adet (${results.capacitorType})</span>
                            </div>
                            ${results.reactorRequired ? `
                            <div class="result-item" style="background: #fff3cd; padding: 8px; border-radius: 5px;">
                                <span class="result-label">3. ‚ö†Ô∏è Seri Reakt√∂rler:</span>
                                <span class="result-value">${results.stageCount} Adet x %${results.reactorPercentage} (Toplam: ${results.reactorPower.toFixed(2)} kVAr)</span>
                            </div>
                            ` : ''}
                            <div class="result-item">
                                <span class="result-label">${results.reactorRequired ? '4' : '3'}. G√º√ß Kontakt√∂rleri:</span>
                                <span class="result-value">${results.stageCount} Adet (AC3 tipi, yardƒ±mcƒ± kontaklƒ±)</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">${results.reactorRequired ? '5' : '4'}. Reaktif G√º√ß Kontrol R√∂lesi (RGKR):</span>
                                <span class="result-value">1 Adet (${results.stageCount} kademe kapasiteli)</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">${results.reactorRequired ? '6' : '5'}. MCB/Sigorta:</span>
                                <span class="result-value">Ana: ${results.mainMCBRating}A + Kademe Ba≈üƒ±na (Detaylar yukarƒ±da)</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">${results.reactorRequired ? '7' : '6'}. ≈ûalterler:</span>
                                <span class="result-value">${results.stageCount + 1} Adet (Ana + Her kademe)</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">${results.reactorRequired ? '8' : '7'}. Akƒ±m Trafosu (CT):</span>
                                <span class="result-value">1 Adet ${Math.ceil(results.totalPanelCurrent * 1.2 / 5) * 5}/5A, Sƒ±nƒ±f 1</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">${results.reactorRequired ? '9' : '8'}. De≈üarj Diren√ßleri:</span>
                                <span class="result-value">${results.stageCount} Adet (Kondansat√∂r ile uyumlu)</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">${results.reactorRequired ? '10' : '9'}. G√∂sterge ve Sinyal:</span>
                                <span class="result-value">LED/Lamba + Alarm Kontaƒüƒ±</span>
                            </div>

                            <h4 style="color: #667eea; margin: 20px 0 15px 0;">üîß KABLOLAMA</h4>
                            <div class="result-item">
                                <span class="result-label">Ana Besleme Kablosu:</span>
                                <span class="result-value">${results.mainBusbarCrossSection}mm¬≤ x 4 (3F+N veya 3F+PE), NYY</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Kademe Kablolarƒ±:</span>
                                <span class="result-value">Her kademe i√ßin detaylar yukarƒ±da belirtilmi≈ütir</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Kontrol Kablolarƒ±:</span>
                                <span class="result-value">0.75-1.5mm¬≤ NYY/NYM (RGKR, Kontakt√∂r kumanda)</span>
                            </div>

                            <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                                <strong>üì¶ Paket ƒ∞√ßeriƒüi Standartlarƒ±:</strong><br>
                                - IEC 60831-1/2 (G√º√ß Kondansat√∂rleri)<br>
                                - EN 60439-1 / IEC 61439-1/2 (Al√ßak Gerilim Panolarƒ±)<br>
                                - IEC 61921 (G√º√ß Kondansat√∂r Devre ≈ûalterleri)<br>
                                ${results.reactorRequired ? '- IEC 60076-6 (Seri Reakt√∂rler)<br>' : ''}
                                - IEC 60947-4-1 (Kontakt√∂rler)<br>
                                - ISO 9001 Kalite Belgeli √úretim<br>
                                - CE Belgeli
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Sonu√ßlara kaydƒ±r
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Grafikleri olu≈ütur
            setTimeout(() => {
                createPowerChart(results);
                createHarmonicChart(results);
                showNotification('Hesaplama tamamlandƒ±!', 'success');
            }, 100);
        }

        function resetAll() {
            if (confirm('T√ºm veriler silinecek. Emin misiniz?')) {
                motors = [];
                devices = [];
                groups = [];
                updateMotorList();
                updateDeviceList();
                updateGroupsList();
                document.getElementById('results').innerHTML = '';

                // localStorage temizleme
                try {
                    if (isLocalStorageAvailable()) {
                        localStorage.removeItem('kompanzasyonData');
                    }
                } catch (e) {
                    console.warn('localStorage temizlenemedi:', e);
                }

                // Chart'larƒ± temizle
                try {
                    if (powerChart) {
                        powerChart.destroy();
                        powerChart = null;
                    }
                    if (harmonicChart) {
                        harmonicChart.destroy();
                        harmonicChart = null;
                    }
                } catch (e) {
                    console.warn('Chart temizleme hatasƒ±:', e);
                }

                lastResults = null;
                showNotification('T√ºm veriler temizlendi', 'success');
            }
        }

        // Bildirim g√∂sterme
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('loadingSpinner').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
            document.getElementById('loadingSpinner').classList.remove('active');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.25s ease-out';
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.style.animation = '';
                }, 250);
            }, 2500);
        }

        // LocalStorage'a kaydetme
        function saveToLocalStorage() {
            if (!isLocalStorageAvailable()) {
                showNotification('localStorage kullanƒ±lamƒ±yor (Gizli mod aktif olabilir)', 'error');
                return;
            }

            try {
                const data = {
                    motors,
                    devices,
                    groups,
                    systemParams: {
                        voltage: document.getElementById('systemVoltage').value,
                        frequency: document.getElementById('systemFrequency').value,
                        currentPF: document.getElementById('currentPowerFactor').value,
                        targetPF: document.getElementById('targetPowerFactor').value,
                        designMode: document.getElementById('designMode').value,
                        totalActivePowerInput: document.getElementById('totalActivePowerInput').value,
                        powerBasedCurrentPF: document.getElementById('powerBasedCurrentPF').value,
                        powerBasedHarmonicLoad: document.getElementById('powerBasedHarmonicLoad').value
                    },
                    timestamp: new Date().toISOString()
                };

                localStorage.setItem('kompanzasyonData', JSON.stringify(data));
                showNotification('Veriler tarayƒ±cƒ±ya kaydedildi', 'success');
            } catch (e) {
                console.error('Kaydetme hatasƒ±:', e);
                showNotification('Veri kaydedilemedi: ' + e.message, 'error');
            }
        }

        // LocalStorage'dan y√ºkleme
        function loadFromLocalStorage() {
            if (!isLocalStorageAvailable()) {
                showNotification('localStorage kullanƒ±lamƒ±yor', 'error');
                return;
            }

            try {
                const savedData = localStorage.getItem('kompanzasyonData');
                if (!savedData) {
                    showNotification('Kaydedilmi≈ü veri bulunamadƒ±', 'error');
                    return;
                }

                const data = JSON.parse(savedData);
                motors = data.motors || [];
                devices = data.devices || [];
                groups = data.groups || [];

                if (data.systemParams) {
                    document.getElementById('systemVoltage').value = data.systemParams.voltage;
                    document.getElementById('systemFrequency').value = data.systemParams.frequency;
                    document.getElementById('currentPowerFactor').value = data.systemParams.currentPF;
                    document.getElementById('targetPowerFactor').value = data.systemParams.targetPF;

                    if (data.systemParams.designMode) {
                        document.getElementById('designMode').value = data.systemParams.designMode;
                    }
                    if (data.systemParams.totalActivePowerInput) {
                        document.getElementById('totalActivePowerInput').value = data.systemParams.totalActivePowerInput;
                    }
                    if (data.systemParams.powerBasedCurrentPF) {
                        document.getElementById('powerBasedCurrentPF').value = data.systemParams.powerBasedCurrentPF;
                    }
                    if (data.systemParams.powerBasedHarmonicLoad) {
                        document.getElementById('powerBasedHarmonicLoad').value = data.systemParams.powerBasedHarmonicLoad;
                    }
                }

                updateMotorList();
                updateDeviceList();
                updateGroupsList();
                updateDesignMode(); // Tasarƒ±m modunu g√ºncelle

                const date = new Date(data.timestamp);
                showNotification(`Veriler y√ºklendi (${date.toLocaleString('tr-TR')})`, 'success');
            } catch (error) {
                showNotification('Veri y√ºkleme hatasƒ±', 'error');
                console.error(error);
            }
        }

        // JSON olarak dƒ±≈üa aktarma
        function exportToJSON() {
            const data = {
                motors,
                devices,
                groups,
                systemParams: {
                    voltage: document.getElementById('systemVoltage').value,
                    frequency: document.getElementById('systemFrequency').value,
                    currentPF: document.getElementById('currentPowerFactor').value,
                    targetPF: document.getElementById('targetPowerFactor').value,
                    designMode: document.getElementById('designMode').value,
                    totalActivePowerInput: document.getElementById('totalActivePowerInput').value,
                    powerBasedCurrentPF: document.getElementById('powerBasedCurrentPF').value,
                    powerBasedHarmonicLoad: document.getElementById('powerBasedHarmonicLoad').value
                },
                timestamp: new Date().toISOString(),
                version: '2.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `kompanzasyon-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);

            showNotification('JSON dosyasƒ± indirildi', 'success');
        }

        // JSON'dan i√ße aktarma
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    motors = data.motors || [];
                    devices = data.devices || [];
                    groups = data.groups || [];

                    if (data.systemParams) {
                        document.getElementById('systemVoltage').value = data.systemParams.voltage;
                        document.getElementById('systemFrequency').value = data.systemParams.frequency;
                        document.getElementById('currentPowerFactor').value = data.systemParams.currentPF;
                        document.getElementById('targetPowerFactor').value = data.systemParams.targetPF;

                        if (data.systemParams.designMode) {
                            document.getElementById('designMode').value = data.systemParams.designMode;
                        }
                        if (data.systemParams.totalActivePowerInput) {
                            document.getElementById('totalActivePowerInput').value = data.systemParams.totalActivePowerInput;
                        }
                        if (data.systemParams.powerBasedCurrentPF) {
                            document.getElementById('powerBasedCurrentPF').value = data.systemParams.powerBasedCurrentPF;
                        }
                        if (data.systemParams.powerBasedHarmonicLoad) {
                            document.getElementById('powerBasedHarmonicLoad').value = data.systemParams.powerBasedHarmonicLoad;
                        }
                    }

                    updateMotorList();
                    updateDeviceList();
                    updateGroupsList();
                    updateDesignMode(); // Tasarƒ±m modunu g√ºncelle

                    showNotification('JSON dosyasƒ± ba≈üarƒ±yla y√ºklendi', 'success');
                } catch (error) {
                    showNotification('JSON dosyasƒ± okunamadƒ±', 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Grafik olu≈üturma
        function createPowerChart(results) {
            const ctx = document.getElementById('powerChart');
            if (!ctx) {
                console.warn('powerChart canvas bulunamadƒ±');
                return;
            }

            // G√ºvenli chart silme
            try {
                if (powerChart) {
                    powerChart.destroy();
                }
            } catch (e) {
                console.warn('Chart destroy hatasƒ±:', e);
            }

            // Chart.js y√ºkl√º m√º kontrol et
            if (typeof Chart === 'undefined') {
                console.error('Chart.js k√ºt√ºphanesi y√ºklenmedi');
                return;
            }

            try {
                powerChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Aktif G√º√ß', 'Mevcut Reaktif', 'Hedef Reaktif', 'Gerekli Kapasitif'],
                    datasets: [{
                        label: 'G√º√ß (kW/kVAr)',
                        data: [
                            results.totalActivePower,
                            results.currentReactivePower,
                            results.targetReactivePower,
                            results.adjustedCapacitivePower
                        ],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(245, 87, 108, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 193, 7, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'G√º√ß Analizi',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'G√º√ß (kW/kVAr)'
                            }
                        }
                    }
                }
            });
            } catch (e) {
                console.error('Chart olu≈üturma hatasƒ±:', e);
                showNotification('Grafik olu≈üturulamadƒ±', 'error');
            }
        }

        function createHarmonicChart(results) {
            const ctx = document.getElementById('harmonicChart');
            if (!ctx) {
                console.warn('harmonicChart canvas bulunamadƒ±');
                return;
            }

            // G√ºvenli chart silme
            try {
                if (harmonicChart) {
                    harmonicChart.destroy();
                }
            } catch (e) {
                console.warn('Chart destroy hatasƒ±:', e);
            }

            // Chart.js y√ºkl√º m√º kontrol et
            if (typeof Chart === 'undefined') {
                console.error('Chart.js k√ºt√ºphanesi y√ºklenmedi');
                return;
            }

            try {
                harmonicChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Harmonik THD %', 'Temiz G√º√ß %'],
                    datasets: [{
                        data: [results.avgTHD, 100 - results.avgTHD],
                        backgroundColor: [
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(40, 167, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(245, 87, 108, 1)',
                            'rgba(40, 167, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Harmonik Analizi',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
            } catch (e) {
                console.error('Harmonik chart olu≈üturma hatasƒ±:', e);
            }
        }

        // PDF rapor olu≈üturma
        function generatePDF() {
            if (!lastResults) {
                showNotification('√ñnce hesaplama yapmalƒ±sƒ±nƒ±z', 'error');
                return;
            }

            showNotification('PDF raporu olu≈üturuluyor...', 'info');

            setTimeout(() => {
                window.print();
                showNotification('PDF i√ßin yazdƒ±rma penceresi a√ßƒ±ldƒ±', 'success');
            }, 500);
        }
    </script>
</body>
</html>
